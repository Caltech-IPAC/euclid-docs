<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIR_RFXModel.SelfCalib &mdash; SIR_RFXModel  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SIR_RFXModel
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">SIR_RFXModel Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SIR_RFXModel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">SIR_RFXModel.SelfCalib</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SIR_RFXModel.SelfCalib</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright (C) 2012-2020 Euclid Science Ground Segment</span>
<span class="c1">#</span>
<span class="c1"># This library is free software; you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c1"># Software Foundation; either version 3.0 of the License, or (at your option)</span>
<span class="c1"># any later version.</span>
<span class="c1">#</span>
<span class="c1"># This library is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more</span>
<span class="c1"># details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with this library; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">File: python/SIR_SelfCalib/SelfCalib.py</span>

<span class="sd">Created on: 04/14/20</span>
<span class="sd">Author: shemmati, Georgio</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">astropy.coordinates</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">wcs</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RegularGridInterpolator</span> <span class="k">as</span> <span class="n">RGI</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndimage</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">stats</span> <span class="c1">#JX</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="c1">#JX</span>

<span class="kn">from</span> <span class="nn">SIR_SpectraExtraction.H5ExtractedSpectraCollection</span> <span class="kn">import</span> <span class="n">H5ExtractedSpectraCollection</span> 
<span class="kn">from</span> <span class="nn">SIR_H5SpectraExtractionBinding</span> <span class="kn">import</span> <span class="n">H5ExtractedSpectrum</span>
<span class="kn">from</span> <span class="nn">SIR_InstrumentModels.DetectorModel</span> <span class="kn">import</span> <span class="n">DetectorModel</span>

<span class="kn">from</span> <span class="nn">SIR_RFXModel.Fit2D</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">SIR_RFXModel.FPA_Geometry_calib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">SIR_RFXModel.Utils_calib</span> <span class="kn">import</span> <span class="o">*</span>


<span class="kn">from</span> <span class="nn">SIR_InstrumentModels.OpticalModel</span> <span class="kn">import</span> <span class="n">OpticalModel</span>
<span class="kn">from</span> <span class="nn">SIR_RFXModel.RelativeFluxCorrectionCore</span> <span class="kn">import</span> <span class="n">RelativeFluxCorrectionCore</span>

<span class="c1">###############################################################################################################</span>
<span class="c1">######################### cal mode 2: simulated dithers magnitude match to GAIA ############################### </span>
<span class="c1">###############################################################################################################</span>

<div class="viewcode-block" id="SelfCalibSirGaiaData">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirGaiaData">[docs]</a>
<span class="k">class</span> <span class="nc">SelfCalibSirGaiaData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to store Self-calibration input and temporary data&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="SelfCalibSirGaiaData.sir_starcatalog">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirGaiaData.sir_starcatalog">[docs]</a>
    <span class="k">def</span> <span class="nf">sir_starcatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h5file</span><span class="p">,</span><span class="n">tables</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; measuring flux in a wavebin for SIR spectra given an </span>
<span class="sd">        h5 file and a location table&#39;&#39;&#39;</span>
    
        <span class="n">det_id</span> <span class="o">=</span> <span class="n">h5file</span><span class="o">.</span><span class="n">getDetectorID</span><span class="p">()</span>
        <span class="n">dither</span> <span class="o">=</span> <span class="n">h5file</span><span class="o">.</span><span class="n">getDither</span><span class="p">()</span>
        <span class="n">loc_t</span> <span class="o">=</span> <span class="n">tables</span>
      
        <span class="n">ids</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span> <span class="o">=</span><span class="p">[],[],[]</span>
        <span class="n">xd</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">xim</span><span class="p">,</span><span class="n">yim</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">jm</span><span class="p">,</span><span class="n">hm</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">chunkm</span><span class="p">,</span><span class="n">dc</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">ifile</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">detectorss</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">detmod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">h5file</span><span class="p">:</span>
                
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">loc_t</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">getObjectID</span><span class="p">()]</span><span class="o">.</span><span class="n">getAstronomicalObject</span><span class="p">()</span>
            <span class="n">ras</span><span class="p">,</span><span class="n">decl</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">getCoords</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">hasMagnitude</span><span class="p">(</span><span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">hasMagnitude</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>
                        
            <span class="n">j_mag</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">getMagnitude</span><span class="p">(</span><span class="s1">&#39;J&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
            <span class="n">h_mag</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">getMagnitude</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>   
            <span class="n">locc</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getLocationSpectrum</span><span class="p">()</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">locc</span><span class="o">.</span><span class="n">computePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span> <span class="c1">## detector coordinates in pixel</span>

            <span class="k">if</span> <span class="n">detmod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">detmod</span> <span class="o">=</span> <span class="n">locc</span><span class="o">.</span><span class="n">getDetectorModel</span><span class="p">()</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getEnvelopeBox</span><span class="p">()</span>
                <span class="n">_xpixels</span> <span class="o">=</span> <span class="n">_det_model</span><span class="o">.</span><span class="n">getDetXPixels</span><span class="p">()</span>
                <span class="n">_ypixels</span> <span class="o">=</span> <span class="n">_det_model</span><span class="o">.</span><span class="n">getDetYPixels</span><span class="p">()</span>
                                
            <span class="p">(</span><span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span><span class="p">)</span> <span class="o">=</span> <span class="n">normaldet</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">maxx</span><span class="o">=</span><span class="n">_xpixels</span><span class="p">,</span><span class="n">maxy</span><span class="o">=</span><span class="n">_ypixels</span><span class="p">)</span> <span class="c1">## detector coordinates [-1,1]            </span>
            <span class="p">(</span><span class="n">xfp</span><span class="p">,</span><span class="n">yfp</span><span class="p">)</span> <span class="o">=</span> <span class="n">normalfov</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getFOVPositions</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">det_id</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1">## focal plane in [-1,1]</span>

        
            <span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualData</span><span class="p">()</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualVariance</span><span class="p">()</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getWavelength</span><span class="p">()</span>    
            <span class="c1">#metadata = spectrum.getAstronomicalObject()</span>
            <span class="c1">#h_mag = metadata.getMagnitude(&#39;H&#39;).getValue() ### added this on March 14, 2024</span>
            <span class="n">mm</span><span class="p">,</span><span class="n">dmm</span> <span class="o">=</span> <span class="n">measureChunkMagnitude1D</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">quality</span><span class="p">,</span><span class="n">center_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span><span class="n">delta_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span><span class="p">)</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">h_mag</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h_mag</span><span class="o">&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mm</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_xpixels</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_ypixels</span><span class="p">):</span>  
                <span class="n">jm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j_mag</span><span class="p">)</span>
                <span class="n">hm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_mag</span><span class="p">)</span>
                <span class="n">chunkm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dmm</span><span class="p">)</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">getObjectID</span><span class="p">())</span>
                <span class="n">xf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xfp</span><span class="p">)</span>
                <span class="n">yf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfp</span><span class="p">)</span>
                <span class="n">xd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdp</span><span class="p">)</span>
                <span class="n">yd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ydp</span><span class="p">)</span>
                <span class="n">xim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">yim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ifile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dither</span><span class="p">)</span>
                <span class="n">detectorss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">det_id</span><span class="p">)</span>
        
        <span class="n">sirr</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Xfp&#39;</span><span class="p">],</span> <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Yfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yf</span><span class="p">)</span>
        <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Xd&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Yd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xd</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yd</span><span class="p">)</span>
        <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Ximage&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;Yimage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xim</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yim</span><span class="p">)</span>
        <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;jmag&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;hmag&#39;</span><span class="p">],</span> <span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;chunkm&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;chunkdm&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;ifile&#39;</span><span class="p">],</span><span class="n">sirr</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jm</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hm</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chunkm</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ifile</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">detectorss</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">sirr</span></div>

                                                                                                                           
<div class="viewcode-block" id="SelfCalibSirGaiaData.gaia2sir">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirGaiaData.gaia2sir">[docs]</a>
    <span class="k">def</span> <span class="nf">gaia2sir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Matching the stars in the NEP from a GAIA catalog down to a limmag </span>
<span class="sd">        to closest (very approximately) sir star&#39;&#39;&#39;</span>
        <span class="n">gaia</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaia</span>
        <span class="n">sirID</span><span class="p">,</span><span class="n">sirxfp</span><span class="p">,</span><span class="n">siryfp</span><span class="p">,</span><span class="n">sirximage</span><span class="p">,</span><span class="n">siryimage</span><span class="p">,</span><span class="n">sirxdet</span><span class="p">,</span><span class="n">sirydet</span><span class="p">,</span><span class="n">sirJ</span><span class="p">,</span><span class="n">sirH</span><span class="p">,</span><span class="n">sirmag</span><span class="p">,</span><span class="n">sirdmag</span><span class="p">,</span><span class="n">sirdither</span><span class="p">,</span><span class="n">sirdetectors</span> <span class="o">=</span> <span class="n">sir</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Xfp&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Yfp&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Ximage&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Yimage&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Xd&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;Yd&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;jmag&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;hmag&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;chunkm&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;chunkdm&#39;</span><span class="p">],</span><span class="n">sir</span><span class="p">[</span><span class="s1">&#39;ifile&#39;</span><span class="p">],</span> <span class="n">sir</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span>
        <span class="c1">#sir15=(sirJ+sirH)/2.0#+ (sirmag-sirH) ### the SIR star magnitude at 1.5 with a correction spectra vs TU</span>
    
        <span class="n">best_star</span><span class="p">,</span><span class="n">starY</span><span class="p">,</span><span class="n">starJ</span><span class="p">,</span><span class="n">starH</span><span class="p">,</span><span class="n">starDetx</span><span class="p">,</span><span class="n">starDety</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">])</span>
        <span class="n">starmag</span><span class="p">,</span><span class="n">stardmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">])</span>
        <span class="n">stardither</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">])</span>
        <span class="n">starFPx</span><span class="p">,</span><span class="n">starFPy</span><span class="p">,</span><span class="n">starimagex</span><span class="p">,</span><span class="n">starimagey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">])</span>
        <span class="n">stardetector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flux2mag</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;rp&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">14</span><span class="p">)</span><span class="ow">and</span><span class="p">(</span><span class="n">flux2mag</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;rp&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">])</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">):</span>
                <span class="c1">#y_g_int = np.interp(1.5,[0.5,3.4],[gaia[&#39;rp&#39;][s],gaia[&#39;w1&#39;][s]])</span>
                <span class="c1">#y_g = flux2mag(5.0*y_g_int)</span>
                <span class="n">y_g</span> <span class="o">=</span> <span class="mf">1.032</span><span class="o">*</span><span class="n">flux2mag</span><span class="p">(</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">])</span><span class="o">-</span><span class="mf">1.55</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sirJ</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">sirJ</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y_g</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">best_star</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirID</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starJ</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirJ</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starH</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirH</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starFPx</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirxfp</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starFPy</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">siryfp</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starDetx</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirxdet</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starDety</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirydet</span> <span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starimagex</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirximage</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starimagey</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">siryimage</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">starmag</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="n">stardmag</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirmag</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">sirdmag</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">stardither</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirdither</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                <span class="n">stardetector</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sirdetectors</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>

        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">starFPx</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">starFPx</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
        <span class="n">best_star1</span><span class="p">,</span><span class="n">starY1</span><span class="p">,</span><span class="n">starJ1</span><span class="p">,</span><span class="n">starH1</span><span class="p">,</span><span class="n">starFPx1</span><span class="p">,</span><span class="n">starFPy1</span><span class="p">,</span><span class="n">starmag1</span><span class="p">,</span><span class="n">stardmag1</span><span class="p">,</span><span class="n">stardither1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        
        <span class="n">starimagex1</span><span class="p">,</span><span class="n">starimagey1</span><span class="p">,</span><span class="n">starDetx1</span><span class="p">,</span><span class="n">starDety1</span><span class="p">,</span><span class="n">stardetector1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        
        <span class="n">best_star1</span><span class="p">,</span><span class="n">starY1</span><span class="p">,</span><span class="n">starJ1</span><span class="p">,</span><span class="n">starH1</span><span class="p">,</span><span class="n">starFPx1</span><span class="p">,</span><span class="n">starFPy1</span><span class="p">,</span><span class="n">starmag1</span><span class="p">,</span><span class="n">stardmag1</span><span class="p">,</span><span class="n">stardither1</span> <span class="o">=</span> <span class="n">best_star</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starY</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starJ</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starH</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starFPx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starFPy</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starmag</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">stardmag</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">stardither</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        
        <span class="n">starimagex1</span><span class="p">,</span><span class="n">starimagey1</span><span class="p">,</span><span class="n">starDetx1</span><span class="p">,</span><span class="n">starDety1</span><span class="p">,</span><span class="n">stardetector1</span> <span class="o">=</span> <span class="n">starimagex</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starimagey</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starDetx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">starDety</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">stardetector</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        
        <span class="n">gra</span><span class="p">,</span><span class="n">gdec</span><span class="p">,</span><span class="n">grp</span><span class="p">,</span><span class="n">gw1</span> <span class="o">=</span> <span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">],</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">],</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;rp&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">],</span><span class="n">gaia</span><span class="p">[</span><span class="s1">&#39;w1&#39;</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>

        <span class="n">gaiasir</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;SIR_ID&#39;</span><span class="p">],</span> <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starXfp&#39;</span><span class="p">],</span> <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starYfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">starDetx1</span><span class="p">)),</span><span class="n">starFPx1</span><span class="p">,</span><span class="n">starFPy1</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starXdet&#39;</span><span class="p">],</span><span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starYdet&#39;</span><span class="p">],</span><span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starXimage&#39;</span><span class="p">],</span><span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;starYimage&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">starDetx1</span><span class="p">,</span><span class="n">starDety1</span><span class="p">,</span><span class="n">starimagex1</span><span class="p">,</span><span class="n">starimagey1</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span><span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;dmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starmag1</span><span class="p">,</span><span class="n">stardmag1</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gra</span><span class="p">,</span> <span class="n">gdec</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;ifile&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">stardither1</span>
        <span class="n">gaiasir</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">stardetector1</span>
    
        <span class="k">return</span> <span class="n">gaiasir</span></div>


<div class="viewcode-block" id="SelfCalibSirGaiaData.dithergaia">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirGaiaData.dithergaia">[docs]</a>
    <span class="k">def</span> <span class="nf">dithergaia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">go</span><span class="p">,</span><span class="n">numdither</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Some survey strategy over the NEP to have stars </span>
<span class="sd">        with nobs~ 1-16 and then change their magnitude based</span>
<span class="sd">        on an input flat cube&#39;&#39;&#39;</span>
        
        <span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">ras</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">decs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#rots = []</span>
        <span class="n">rollangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numdither</span><span class="p">:</span>
            <span class="n">randra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">266.5</span><span class="p">,</span><span class="mf">270.5</span><span class="p">)</span>
            <span class="n">randdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">64.75</span><span class="p">,</span><span class="mf">66.25</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">randra</span><span class="o">-</span><span class="mf">268.625</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">randdec</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">randdec</span><span class="o">-</span><span class="mf">65.6</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="n">ras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">randra</span><span class="p">)</span>
                <span class="n">decs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">randdec</span><span class="p">)</span>
                <span class="c1">#rots.append(np.random.uniform(-180,180))</span>
        <span class="c1"># survey part</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">])</span>
        <span class="n">nid</span><span class="p">,</span><span class="n">nra</span><span class="p">,</span><span class="n">ndec</span><span class="p">,</span><span class="n">nmag</span><span class="p">,</span><span class="n">ndmag</span><span class="p">,</span><span class="n">nxfp</span><span class="p">,</span><span class="n">nyfp</span><span class="p">,</span><span class="n">nifile</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[]</span>
        <span class="n">nxdet</span><span class="p">,</span><span class="n">nydet</span><span class="p">,</span><span class="n">nxim</span><span class="p">,</span><span class="n">nyim</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="n">newX</span><span class="p">,</span><span class="n">newY</span> <span class="o">=</span> <span class="p">[],[]</span> 
        <span class="n">ndetector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ras</span><span class="p">)):</span>
            <span class="n">testw</span> <span class="o">=</span> <span class="n">get_euclid_wcs</span><span class="p">(</span><span class="n">ras</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">decs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">roll</span><span class="o">=</span><span class="n">rollangle</span><span class="p">)</span>

            <span class="c1">#Get pixel coordinates of each star, convert to FOV coordinate (-1 to 1 in both dimensions)</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">testw</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">fovx</span> <span class="o">=</span> <span class="n">px</span><span class="o">/</span><span class="mf">1e4</span>
            <span class="n">fovy</span> <span class="o">=</span> <span class="n">py</span><span class="o">/</span><span class="mf">1e4</span>

            <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fovx</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fovy</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">stars_in_pointing</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>

            <span class="n">ra2</span><span class="p">,</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">sirid</span><span class="p">,</span><span class="n">sdetx</span><span class="p">,</span><span class="n">sdety</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;SIR_ID&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;starXdet&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;starYdet&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">sfpx</span><span class="p">,</span><span class="n">sfpy</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;starXfp&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;starYfp&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">simx</span><span class="p">,</span><span class="n">simy</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;starXimage&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;starYimage&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">nx</span><span class="p">,</span><span class="n">ny</span> <span class="o">=</span> <span class="n">fovx</span><span class="p">[</span><span class="n">ss</span><span class="p">],</span><span class="n">fovy</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">smag</span><span class="p">,</span><span class="n">sdmag</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;dmag&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">sdither</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;ifile&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">sdetector</span> <span class="o">=</span> <span class="n">go</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="n">go</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="n">ss</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mi">256</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ras</span><span class="p">))))</span>        

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ra2</span><span class="p">)):</span>
                <span class="n">nra</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ra2</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">ndec</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dec2</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nid</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sirid</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nxfp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sfpx</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nyfp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sfpy</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nxdet</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sdetx</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nydet</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sdety</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nxim</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">simx</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nyim</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">simx</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nmag</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">smag</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">ndmag</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sdmag</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>             
                <span class="n">newX</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">nx</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">newY</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ny</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">nifile</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sdither</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                <span class="n">ndetector</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sdetector</span><span class="p">[</span><span class="n">s</span><span class="p">]])</span>
                
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;02-RADEC.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    
        <span class="c1"># Change of magnitudes</span>
        <span class="n">X</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Y</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Z</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wstart</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wend</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#JX</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)</span> <span class="c1">## interpolating on the response</span>
        <span class="n">mag_new</span><span class="p">,</span><span class="n">dmag_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nmag</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ndmag</span><span class="p">)</span>
        <span class="n">ndet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nmag</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nra</span><span class="p">)):</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">((</span><span class="n">nmag</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="mf">25.0</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)</span><span class="c1">#mag[i]#</span>
            <span class="n">pts_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span><span class="n">nxfp</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">nyfp</span><span class="p">[</span><span class="n">k</span><span class="p">]]])</span>
            <span class="n">pts_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span><span class="n">newX</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">newY</span><span class="p">[</span><span class="n">k</span><span class="p">]]])</span> 
            <span class="n">mag_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span> <span class="o">*</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">pts_new</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">pts_old</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)))</span><span class="o">+</span><span class="mf">25.0</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">ndmag</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>


        <span class="c1"># saving with the format readable by the rest of SIR self calib data</span>
        <span class="n">gaiasirdither</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;X_fp&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;Y_fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nid</span><span class="p">,</span><span class="n">newX</span><span class="p">,</span><span class="n">newY</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span><span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_new</span><span class="p">,</span><span class="n">ndmag</span><span class="o">+</span><span class="mf">0.0001</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ndmag</span><span class="p">))</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;ALPHA_J2000&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;DELTA_J2000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nra</span><span class="p">,</span> <span class="n">ndec</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;FLAGS_EXTRACTION&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;FLAGS_SCAMP&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;FLAGS_IMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nra</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nra</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">nra</span><span class="p">)</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;ifile&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nifile</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">ndetector</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxim</span><span class="p">,</span> <span class="n">nyim</span>
        <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;X_det&#39;</span><span class="p">],</span> <span class="n">gaiasirdither</span><span class="p">[</span><span class="s1">&#39;Y_det&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxdet</span><span class="p">,</span> <span class="n">nydet</span>
    
        <span class="k">return</span> <span class="n">gaiasirdither</span></div>


<div class="viewcode-block" id="SelfCalibSirGaiaData.extractStarCatalog">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirGaiaData.extractStarCatalog">[docs]</a>
    <span class="k">def</span> <span class="nf">extractStarCatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="c1"># Prepare catalog of individual stars</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">])</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>     <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>

        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_star2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_star2obs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">index_star2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">size</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">idet</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_det2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_det2obs</span><span class="p">)</span>
        <span class="c1">#assert np.min(catalog[&#39;nobs&#39;]) == 2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">index_star2obs</span><span class="p">,</span> <span class="n">index_det2obs</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extspecnames</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">ncoeff</span><span class="p">,</span> <span class="n">limmag</span><span class="p">,</span> <span class="n">wcenter</span><span class="p">,</span> <span class="n">deltaw</span><span class="p">,</span> <span class="n">grism_param</span><span class="p">,</span> <span class="n">noisefactor</span><span class="p">,</span> <span class="n">ndither</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        
        <span class="n">obs</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span>

        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">ncoeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span> <span class="o">=</span> <span class="n">limmag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span> <span class="o">=</span> <span class="n">wcenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span> <span class="o">=</span> <span class="n">deltaw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span> <span class="o">=</span> <span class="n">noisefactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndither</span> <span class="o">=</span> <span class="n">ndither</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span>

        <span class="c1">#JX</span>
        <span class="n">exspectra_test</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">extspecnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
        <span class="n">spectra</span> <span class="o">=</span> <span class="n">exspectra_test</span><span class="o">.</span><span class="n">getExtractedSpectra</span><span class="p">()</span>
        <span class="n">wavetest</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWavelength</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wstart</span> <span class="o">=</span> <span class="n">wavetest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wend</span> <span class="o">=</span> <span class="n">wavetest</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wavetest</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">fakecube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;EUC_SIR_W-RELATIVEFLUX-SCALE_3_manual_newDM_2022Nov29.fits&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fakecube_name</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># all 0 grism# vignetted tilted grism</span>
                
        <span class="n">gaia_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;euclid_selfcal_stars_gaia_allwise_2021july26.fits&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">gaia</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">gaia_name</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Read input files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading spectra&quot;</span><span class="p">)</span>
        <span class="n">sirr</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extspecnames</span><span class="p">):</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getGWAPosition</span><span class="p">()</span><span class="o">+</span><span class="n">tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getGWATilt</span><span class="p">())</span> <span class="o">==</span> <span class="n">grism_param</span><span class="p">:</span>
                <span class="n">exspectra</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Loading file &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> 

                <span class="n">sirr_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sir_starcatalog</span> <span class="p">(</span><span class="n">exspectra</span><span class="p">,</span><span class="n">tables</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sirr</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">sirr</span> <span class="o">=</span> <span class="n">sirr_one</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sirr</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sirr</span><span class="p">,</span><span class="n">sirr_one</span><span class="p">])</span>
        
        <span class="n">gaiasir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaia2sir</span><span class="p">(</span><span class="n">sirr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithergaia</span><span class="p">(</span><span class="n">gaiasir</span><span class="p">,</span><span class="n">numdither</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ndither</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">obs</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="c1"># Sort by star magnitude</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">index_star2obs</span><span class="p">,</span> <span class="n">index_det2obs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractStarCatalog</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">index_star2obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">index_det2obs</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of coefficients in the model                : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of individual stars                         : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of constraints                              : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mag. uncertainty&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;03-SourceMagAndUnc.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;ALPHA_J2000&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;DELTA_J2000&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;01-RADEC.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div>


<span class="c1">###############################################################################################################</span>
<span class="c1">###################################### cal mode 1: random dithered observations ############################### </span>
<span class="c1">###############################################################################################################</span>

<div class="viewcode-block" id="SelfDitherData">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfDitherData">[docs]</a>
<span class="k">class</span> <span class="nc">SelfDitherData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;To manually dither and generate more data&quot;&quot;&quot;</span>
    
    
<div class="viewcode-block" id="SelfDitherData.extractStarCatalog2">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfDitherData.extractStarCatalog2">[docs]</a>
    <span class="k">def</span> <span class="nf">extractStarCatalog2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="c1"># Prepare catalog of individual stars</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">])</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>     <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>

        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_star2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_star2obs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">index_star2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">size</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">idet</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_det2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_det2obs</span><span class="p">)</span>
        <span class="c1">#assert np.min(catalog[&#39;nobs&#39;]) == 2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">index_star2obs</span><span class="p">,</span> <span class="n">index_det2obs</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">gwapos</span><span class="p">,</span> <span class="n">ndithers</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">noisefactor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">limmag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">wcenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndithers</span> <span class="o">=</span> <span class="n">ndithers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span> <span class="o">=</span> <span class="n">noisefactor</span>
        <span class="n">fakecube_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;EUC_SIR_W-RELATIVEFLUX-SCALE_3_manual_newDM_2022Nov29.fits&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fakecube_name</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># a vignetted tilted grism</span>
        <span class="c1">#self.cube = illuminate() </span>
        <span class="n">detmod</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="p">(</span><span class="n">gwapos</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># change false to True once new data</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getEnvelopeBox</span><span class="p">()</span>

        <span class="n">idd</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span>
        <span class="c1">#ra,dec = data.obs[&#39;ALPHA_J2000&#39;],data.obs[&#39;DELTA_J2000&#39;]</span>
        <span class="n">xfp</span><span class="p">,</span><span class="n">yfp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;X_fp&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Y_fp&#39;</span><span class="p">]</span>
        <span class="n">mag</span><span class="p">,</span><span class="n">magerr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">]</span>

        <span class="n">sidd</span><span class="p">,</span><span class="n">sximage</span><span class="p">,</span><span class="n">syimage</span><span class="p">,</span><span class="n">sxd</span><span class="p">,</span><span class="n">syd</span><span class="p">,</span><span class="n">sxf</span><span class="p">,</span><span class="n">syf</span><span class="p">,</span><span class="n">smag</span><span class="p">,</span><span class="n">smagerr</span><span class="p">,</span><span class="n">sflag1</span><span class="p">,</span><span class="n">sflag2</span><span class="p">,</span><span class="n">sflag3</span><span class="p">,</span><span class="n">sdet</span><span class="p">,</span><span class="n">sdither</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[],[],[],[],[],[],[]</span>
        <span class="n">obs2</span> <span class="o">=</span> <span class="p">()</span>
        
        <span class="n">X</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Y</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="o">&lt;</span><span class="mi">12500</span><span class="p">:</span>
            <span class="c1">#Z =  np.linspace(8548.5,13862.1,np.shape(self.cube)[0])</span>
            <span class="n">Z</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">9000.0</span><span class="p">,</span><span class="mf">13862.1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Z</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">11900.0</span><span class="p">,</span><span class="mf">19002.0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> 
            
        <span class="n">fn</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)</span> <span class="c1">## interpolating on the response</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dithering spectra&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xfp</span><span class="p">)):</span>
            <span class="c1">#det_new = np.random.randint(0,16,self.ndithers) # which detector</span>
            <span class="c1">#det_id = [&#39;11&#39;,&#39;12&#39;,&#39;13&#39;,&#39;14&#39;,&#39;21&#39;,&#39;22&#39;,&#39;23&#39;,&#39;24&#39;,&#39;31&#39;,&#39;32&#39;,&#39;33&#39;,&#39;34&#39;,&#39;41&#39;,&#39;42&#39;,&#39;43&#39;,&#39;44&#39;]</span>

            <span class="n">flux</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">((</span><span class="n">mag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mf">25.0</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)</span><span class="c1">#mag[i]#</span>
            <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndithers</span><span class="p">:</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#normalized fp x </span>
                <span class="n">y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#normalized fp y</span>
                <span class="n">fov</span> <span class="o">=</span> <span class="n">normalfov_r</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_new</span><span class="p">,</span><span class="n">y_new</span><span class="p">]))</span> <span class="c1">#fov coordinates in mm</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getPixel</span><span class="p">(</span><span class="n">fov</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># pixel coordinates</span>
                <span class="k">if</span> <span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">detid</span> <span class="o">=</span> <span class="n">pix</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">()</span>
                    <span class="n">pts_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span><span class="n">xfp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">yfp</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>
                    <span class="n">pts_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">]])</span> 
                    <span class="n">mag_new</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span> <span class="o">*</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">pts_new</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">pts_old</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)))</span><span class="o">+</span><span class="mf">25.0</span>
                    <span class="n">sidd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">sximage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fov</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#in mm not sure</span>
                    <span class="n">syimage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fov</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#in mm</span>
                    <span class="c1">#sdet.append(det_id[det_new[j]])</span>
                    <span class="n">sdet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detid</span><span class="p">)</span>
                    <span class="n">sdither</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">sxd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xd</span><span class="p">)</span>
                    <span class="n">syd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yd</span><span class="p">)</span>
                    <span class="n">sxf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                    <span class="n">syf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_new</span><span class="p">)</span>
                    <span class="c1">#sra.append(ra[i])</span>
                    <span class="c1">#sdec.append(dec[i])</span>
                    <span class="n">smag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">magerr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span><span class="p">))</span> <span class="c1"># added some noise </span>
                    <span class="n">smagerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magerr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">sflag1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">sflag2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">sflag3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ALPHA_J2000&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DELTA_J2000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sidd</span><span class="p">,</span><span class="n">sximage</span><span class="p">,</span><span class="n">syimage</span><span class="p">,</span><span class="n">sra</span><span class="p">,</span><span class="n">sdec</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smag</span><span class="p">,</span> <span class="n">smagerr</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_EXTRACTION&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_SCAMP&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_IMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sflag1</span><span class="p">,</span><span class="n">sflag2</span><span class="p">,</span><span class="n">sflag3</span>
            
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ifile&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sdither</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;idet&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sdet</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="c1">#(x, y) = pixel2focalplane(data[&#39;idet&#39;], data[&#39;X_IMAGE&#39;], data[&#39;Y_IMAGE&#39;])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X_fp&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sxf</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y_fp&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">syf</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># Trasform x and y coordinates into the [-1,1] range on the detector</span>
        <span class="c1">#(x, y) = pixel2det(data[&#39;idet&#39;], data[&#39;X_IMAGE&#39;], data[&#39;Y_IMAGE&#39;])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X_det&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sxd</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y_det&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">syd</span><span class="p">);</span> <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obs2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs2</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">obs2</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span>
            
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obs2</span> <span class="o">=</span> <span class="n">obs2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">index_star2obs</span><span class="p">,</span> <span class="n">index_det2obs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractStarCatalog2</span><span class="p">(</span><span class="n">obs2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">obs2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">index_star2obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">index_det2obs</span></div>

                    
<span class="c1">###############################################################################################################</span>
<span class="c1">###################################### cal mode 0: main mode for selfcal observations ######################### </span>
<span class="c1">###############################################################################################################</span>

<div class="viewcode-block" id="SelfCalibSirData">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirData">[docs]</a>
<span class="k">class</span> <span class="nc">SelfCalibSirData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to store Self-calibration input and temporary data&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="SelfCalibSirData.remove_unique_object_ids">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirData.remove_unique_object_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_unique_object_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">repeated_ids</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">],</span> <span class="n">repeated_ids</span><span class="p">)]</span></div>


<div class="viewcode-block" id="SelfCalibSirData.sigmaclip">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirData.sigmaclip">[docs]</a>
    <span class="k">def</span> <span class="nf">sigmaclip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">object_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">object_id</span> <span class="ow">in</span> <span class="n">object_ids</span><span class="p">:</span>
            <span class="n">current_entries</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_id</span><span class="p">]</span>
            <span class="n">median_mag_aper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">current_entries</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">])</span>
            <span class="n">std_mag_aper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">current_entries</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_entries</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">median_mag_aper</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">std_mag_aper</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">current_entries</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">median_mag_aper</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">std_mag_aper</span><span class="p">)</span>
            <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">final_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">final_mask</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="SelfCalibSirData.extractStarCatalog">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibSirData.extractStarCatalog">[docs]</a>
    <span class="k">def</span> <span class="nf">extractStarCatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="c1"># Prepare catalog of individual stars</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">])</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>     <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>
        <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">))</span>

        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_star2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="c1">#JX index_star2obs = np.asarray(index_star2obs) #JX 10-25-2024: Added dtype=object to remove warning message.</span>
        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_star2obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">index_star2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">size</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;unc&#39;</span><span class="p">][</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="c1">#np.std( obs[&#39;MAG_APER&#39;][j])</span>
            <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">idet</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">index_det2obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1">#JX index_det2obs = np.asarray(index_det2obs) #JX 10-25-2024: Added dtype=object to remove warning message.</span>
        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_det2obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="c1">#assert np.min(catalog[&#39;nobs&#39;]) == 2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">index_star2obs</span><span class="p">,</span> <span class="n">index_det2obs</span><span class="p">)</span></div>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extspecnames</span><span class="p">,</span><span class="n">listallgrisms</span><span class="p">,</span> <span class="n">ncoeff</span><span class="p">,</span> <span class="n">limmag</span><span class="p">,</span> <span class="n">wcenter</span><span class="p">,</span> <span class="n">deltaw</span><span class="p">,</span> <span class="n">grism_param</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        
        <span class="c1">#JX 10-25-2024 SpeedUp: Created the following lists.</span>
        <span class="c1">#obs = ()</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="c1">#JXJXJX</span>

        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">ncoeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span> <span class="o">=</span> <span class="n">limmag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span> <span class="o">=</span> <span class="n">wcenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span> <span class="o">=</span> <span class="n">deltaw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;aux&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Read input files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading spectra&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extspecnames</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">listallgrisms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">grism_param</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#exspectra = H5ExtractedSpectraCollection.load(filename, ids=[H5ExtractedSpectrum.SPEC1D_LABEL,RelativeFluxCorrectionCore.SPEC1D_RELFLUX_LABEL, ])</span>
                    <span class="n">exspectra</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,</span> <span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no 1d rel?&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="c1">#if (exspectra.getGWAPosition()+exspectra.getGWATilt()) == grism_param:</span>
                <span class="n">idet</span> <span class="o">=</span> <span class="n">exspectra</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">()</span>
                <span class="n">det_id</span> <span class="o">=</span> <span class="n">exspectra</span><span class="o">.</span><span class="n">getDetectorID</span><span class="p">()</span>
                
                <span class="n">dither</span> <span class="o">=</span> <span class="n">exspectra</span><span class="o">.</span><span class="n">getDither</span><span class="p">()</span>
                <span class="c1">#loc_t = tables[k]</span>
      
                <span class="n">idd</span><span class="p">,</span><span class="n">ximage</span><span class="p">,</span><span class="n">yimage</span><span class="p">,</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">mag</span><span class="p">,</span><span class="n">magerr</span><span class="p">,</span><span class="n">flag1</span><span class="p">,</span><span class="n">flag2</span><span class="p">,</span><span class="n">flag3</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[],[],[]</span>
                <span class="n">xfp</span><span class="p">,</span><span class="n">yfp</span><span class="p">,</span><span class="n">xdn</span><span class="p">,</span><span class="n">ydn</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
                
                <span class="n">detmod</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="c1">#detmod = DetectorModel(exspectra.getGWAPositionName(), mdb, rotate=True)</span>

                <span class="c1">#JX 10-25-2024 SpeedUp: Created the loop on n</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">)):</span>

                    <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">exspectra</span><span class="p">:</span>   
                        <span class="c1">#metadata = loc_t[spectrum.getObjectID()].getAstronomicalObject()</span>
                        <span class="c1">#ras,decl = metadata.getCoords()</span>
                        <span class="c1">#h_mag = metadata.getMagnitude(&#39;H&#39;).getValue()</span>
                        <span class="c1">#### new</span>
                        <span class="n">locc</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getLocationSpectrum</span><span class="p">()</span>
                        <span class="n">xy</span> <span class="o">=</span> <span class="n">locc</span><span class="o">.</span><span class="n">computePosition</span><span class="p">(</span><span class="n">wcenter</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span> <span class="c1">## detector coordinates in pixel</span>

                        <span class="k">if</span> <span class="n">detmod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">detmod</span> <span class="o">=</span> <span class="n">locc</span><span class="o">.</span><span class="n">getDetectorModel</span><span class="p">()</span>
                            <span class="n">box</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getEnvelopeBox</span><span class="p">()</span>
                            <span class="n">_xpixels</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getDetXPixels</span><span class="p">()</span>
                            <span class="n">_ypixels</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getDetYPixels</span><span class="p">()</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1">#flux = spectrum.getSpectrumDataSet(RelativeFluxCorrectionCore.SPEC1D_RELFLUX_LABEL).getActualData()</span>
                            <span class="c1">#var = spectrum.getSpectrumDataSet(RelativeFluxCorrectionCore.SPEC1D_RELFLUX_LABEL).getActualVariance()</span>
                            <span class="c1">#quality = spectrum.getSpectrumDataSet(H5ExtractedSpectrum.SPEC1D_LABEL).getQuality()</span>
                            <span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span><span class="o">.</span><span class="n">getActualData</span><span class="p">()</span>
                            <span class="n">var</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span><span class="o">.</span><span class="n">getActualVariance</span><span class="p">()</span>
                            <span class="n">quality</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()</span>
                            <span class="n">wave</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getWavelength</span><span class="p">()</span>    
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coudn&#39;t use spectrum&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getAstronomicalObject</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">hasMagnitude</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">h_mag</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">getMagnitude</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                        <span class="c1">#### and (spectrum.getObjectID()%2==0)</span>
                                            
                        <span class="k">if</span> <span class="p">(</span><span class="n">h_mag</span><span class="o">&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="ow">and</span><span class="p">(</span><span class="n">h_mag</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_xpixels</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_ypixels</span><span class="p">):</span>
                            <span class="n">m</span><span class="p">,</span><span class="n">dm</span> <span class="o">=</span> <span class="n">measureChunkMagnitude1D</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">quality</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wcenter</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span><span class="p">)</span>    
                            <span class="p">(</span><span class="n">xd</span><span class="p">,</span><span class="n">yd</span><span class="p">)</span> <span class="o">=</span> <span class="n">normaldet</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">maxx</span><span class="o">=</span><span class="n">_xpixels</span><span class="p">,</span> <span class="n">maxy</span><span class="o">=</span><span class="n">_ypixels</span><span class="p">)</span> <span class="c1">## detector coordinates [-1,1]</span>
                            <span class="p">(</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">)</span> <span class="o">=</span> <span class="n">normalfov</span><span class="p">(</span><span class="n">box</span><span class="p">,</span><span class="n">detmod</span><span class="o">.</span><span class="n">getFOVPositions</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">det_id</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1">## focal plane in [-1,1]</span>

                            <span class="c1">#snr = 1/(1 - np.power(10,-0.4*dm)) dm&lt;0.1 == snr&gt;10</span>
                            <span class="k">if</span> <span class="n">dm</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">:</span>
                                <span class="c1">#if m&gt;-90:</span>
                                <span class="n">idd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">getObjectID</span><span class="p">())</span>
                                <span class="n">ximage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">yimage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">xdn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xd</span><span class="p">)</span>
                                <span class="n">ydn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yd</span><span class="p">)</span>
                                <span class="n">xfp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span>
                                <span class="n">yfp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yf</span><span class="p">)</span>
                                <span class="c1">#ra.append(ras)</span>
                                <span class="c1">#dec.append(decl)</span>
                                <span class="n">mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                                <span class="n">magerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
                                <span class="n">flag1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">flag2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">flag3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
                    <span class="c1">#data[&#39;OBJECT_ID&#39;],data[&#39;X_IMAGE&#39;],data[&#39;Y_IMAGE&#39;], data[&#39;ALPHA_J2000&#39;],data[&#39;DELTA_J2000&#39;] = idd,ximage,yimage,ra,dec</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;OBJECT_ID&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_IMAGE&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_IMAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idd</span><span class="p">,</span><span class="n">ximage</span><span class="p">,</span><span class="n">yimage</span>                
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span><span class="p">,</span> <span class="n">magerr</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_EXTRACTION&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_SCAMP&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLAGS_IMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag1</span><span class="p">,</span><span class="n">flag2</span><span class="p">,</span><span class="n">flag3</span>
                    <span class="c1">#print(&#39;number chunks added this h5file:&#39;,len(idd))</span>

                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ifile&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">dither</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idd</span><span class="p">)));</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;idet&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idd</span><span class="p">)));</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                    <span class="c1">#(x, y) = pixel2focalplane(data[&#39;idet&#39;], data[&#39;X_IMAGE&#39;], data[&#39;Y_IMAGE&#39;])</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X_fp&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xfp</span><span class="p">);</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y_fp&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">yfp</span><span class="p">);</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                    <span class="c1"># Trasform x and y coordinates into the [-1,1] range on the detector</span>
                    <span class="c1">#(x, y) = pixel2det(idet, data[&#39;X_IMAGE&#39;], data[&#39;Y_IMAGE&#39;])</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;X_det&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xdn</span><span class="p">);</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Y_det&#39;</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ydn</span><span class="p">);</span> 
                    <span class="n">data</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
       
                    <span class="c1">#JXJXJX 10-25-2024 SpeedUp: Replaced the following section with the obs list.</span>
<span class="w">                    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    if len(obs) == 0:</span>
<span class="sd">                        obs = data.copy()</span>
<span class="sd">                    else:</span>
<span class="sd">                        obs = astropy.table.vstack([obs, data])</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">data</span><span class="p">])</span>                    
                <span class="c1">#JXJXJX</span>
        
        <span class="c1">#JX 10-25-2024 SpeedUp: Moved the following section into a loop down below.</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        nn = len(obs)</span>
<span class="sd">        # Sort by star magnitude</span>
<span class="sd">        i = np.argsort(obs[&#39;MAG_APER&#39;])[::-1]</span>
<span class="sd">        obs = obs[i]</span>
<span class="sd">        print(&quot;Number of individual stars before repeat           : &quot;, len(obs))</span>

<span class="sd">        ############ Added these two lines to remove non repeated observations and outlier magnitudes</span>
<span class="sd">        obs = self.remove_unique_object_ids(obs)</span>
<span class="sd">        print(&quot;Number of individual stars single ones removed           : &quot;, len(obs))</span>

<span class="sd">        obs = self.sigmaclip(obs)</span>
<span class="sd">        print(&quot;Number of stars 3sigma clipped magnitudes           : &quot;, len(obs))</span>

<span class="sd">        ################################################</span>
<span class="sd">        (catalog, index_star2obs, index_det2obs) = self.extractStarCatalog(obs)</span>

<span class="sd">        self.obs = obs</span>
<span class="sd">        self.catalog = catalog</span>
<span class="sd">        self.index_star2obs = index_star2obs</span>
<span class="sd">        self.index_det2obs = index_det2obs</span>

<span class="sd">        print(&quot;Number of coefficients in the model                : &quot;, self.ncoeff)</span>
<span class="sd">        print(&quot;Number of individual stars                         : &quot;, len(catalog))</span>
<span class="sd">        print(&quot;Number of constraints                              : &quot;, len(obs))</span>
<span class="sd"> </span>
<span class="sd">        if self.outdir is not None:</span>
<span class="sd">            fig = plt.figure()</span>
<span class="sd">            plt.plot(obs[&#39;MAG_APER&#39;], obs[&#39;MAGERR_APER&#39;], marker=&#39;.&#39;, linestyle=&quot;None&quot;, ms=1.5)</span>
<span class="sd">            plt.xlabel(&quot;Magnitude&quot;)</span>
<span class="sd">            plt.ylabel(&quot;Mag. uncertainty&quot;)</span>
<span class="sd">            plt.yscale(&quot;log&quot;)</span>
<span class="sd">            plt.savefig(os.path.join(outdir, f&#39;03-SourceMagAndUnc_w{wcenter}_g{grism_param}.png&#39;), dpi=200)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#JXJXJX</span>
            
        <span class="c1">#JX 10-25-2024 SpeedUp: Created the following lists and the loop on n.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">))]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenter</span><span class="p">)):</span> 
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n=&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s2">&quot; wcenter_n=&quot;</span><span class="p">,</span><span class="n">wcenter</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="c1"># Sort by star magnitude</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of individual stars before repeat           : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>

            <span class="c1">############ Added these two lines to remove non repeated observations and outlier magnitudes</span>
            <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_unique_object_ids</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of individual stars single ones removed     : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>

            <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaclip</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars 3sigma clipped magnitudes          : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>    

            <span class="c1">################################################</span>
            <span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">index_star2obs</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">index_det2obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractStarCatalog</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_star2obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_star2obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_det2obs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of coefficients in the model                : &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of individual stars                         : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of constraints                              : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mag. uncertainty&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                <span class="c1">#JX plt.savefig(os.path.join(outdir, &quot;03-SourceMagAndUnc_w&quot;+str(wcenter)+&quot;_g&quot;+str(grism_param)+&quot;.png&quot;), dpi=200)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;03-SourceMagAndUnc_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wcenter</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;_g&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">grism_param</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div>

        <span class="c1">#JXJXJX</span>
            
<span class="c1">###################################################################################################</span>
<span class="c1">#################### SelfCalibration on wavelength bins [main]###########################################</span>
<span class="c1">###################################################################################################</span>

<div class="viewcode-block" id="SelfCalibWave">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave">[docs]</a>
<span class="k">class</span> <span class="nc">SelfCalibWave</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to run self calibration over wavelength direction&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extspecnames</span><span class="p">,</span> <span class="n">listallgrisms</span><span class="p">,</span> <span class="n">ncoeff</span><span class="p">,</span> <span class="n">limmag</span><span class="p">,</span> <span class="n">calmode</span><span class="p">,</span><span class="n">smooth_kernel_sigma</span><span class="p">,</span> <span class="n">noisefactor</span><span class="p">,</span> <span class="n">deltaw</span><span class="p">,</span> <span class="n">spatialres</span><span class="p">,</span> <span class="n">waveres</span><span class="p">,</span> <span class="n">ndither</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">optxml</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span><span class="n">ms_flat</span><span class="p">,</span><span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span> <span class="o">=</span> <span class="n">extspecnames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listallgrisms</span> <span class="o">=</span> <span class="n">listallgrisms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_grisms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">listallgrisms</span><span class="p">)</span> 
 
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">ncoeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span> <span class="o">=</span> <span class="n">limmag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calmode</span> <span class="o">=</span> <span class="n">calmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span> <span class="o">=</span> <span class="n">noisefactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel_sigma</span> <span class="o">=</span> <span class="n">smooth_kernel_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span> <span class="o">=</span> <span class="n">deltaw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatialres</span> <span class="o">=</span> <span class="n">spatialres</span>
        
<span class="c1">#        self.dq_parameters = ppr_dict.genericKeyValueParameters() #JX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dq_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">waveres</span> <span class="o">=</span> <span class="n">waveres</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialres</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialres</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span><span class="c1"># MakeCubeTess(ms_flat)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errcube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ndither</span> <span class="o">=</span> <span class="n">ndither</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optxml</span> <span class="o">=</span> <span class="n">optxml</span>

<div class="viewcode-block" id="SelfCalibWave.fit">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave.fit">[docs]</a>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;looping over wavelengths and filling in the cube using self calib fitting&#39;&#39;&#39;</span>
                
        <span class="n">grisms_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RGS000&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180+4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS000-4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">,</span><span class="s1">&#39;RGS270&#39;</span><span class="p">,</span><span class="s1">&#39;BGS000&#39;</span><span class="p">]</span> <span class="c1">#order of grisms!</span>
        <span class="n">list_grisms_main</span> <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="c1">### change 0 when blue grism and RGS270 data exists</span>
        
        <span class="k">for</span> <span class="n">ggbuf</span><span class="p">,</span><span class="n">grism</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_grisms</span><span class="p">):</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;in SelfCalibWave fit(): ggbuf,grism= &quot;</span><span class="p">,</span><span class="n">ggbuf</span><span class="p">,</span><span class="n">grism</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grism</span>  <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1">#JX wstart = 11000.0 # 8548.5problematic</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">9000.0</span><span class="c1">#8548.5</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">13862.1</span>
                <span class="n">wcenters</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">11900.0</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">19002.0</span>
                <span class="n">wcenters</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#JX 10-25-2024 SpeedUp: Moved the following section to outside of loop on i.</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;   </span>
<span class="sd">            for i in range(self.waveres):</span>
<span class="sd">                spec_forGW = H5ExtractedSpectraCollection.load(self.extspecnames[0], ids=[H5ExtractedSpectrum.SPEC1D_LABEL,])     </span>
<span class="sd">                ## if self cal observations or simulations exist no need to dither things (default mode = 0)</span>
<span class="sd">                if self.calmode==0:</span>
<span class="sd">                    data2 = SelfCalibSirData(self.extspecnames,self.listallgrisms, self.ncoeff, self.limmag, wcenters[i],self.deltaw,grism,self.mdb,outdir=self.outdir)</span>
<span class="sd">                    </span>
<span class="sd">                ## simple random simulation of dithering spectra in the absence of SelfCal observations (mode = 1)    </span>
<span class="sd">                elif self.calmode==1:</span>
<span class="sd">                    data = SelfCalibSirData(self.extspecnames, self.ncoeff, self.limmag, wcenters[i],self.deltaw,grism,self.mdb,outdir=self.outdir)</span>
<span class="sd">                    data2 = SelfDitherData(data, self.mdb, spec_forGW.getGWAPositionName(), ndithers=self.ndither,noisefactor = self.noisefactor) </span>
<span class="sd">                    </span>
<span class="sd">                ## More realistic simulation of selfCal pattern using GAIA star positions in the absence of SelfCal (mode=2)    </span>
<span class="sd">                else:</span>
<span class="sd">                    data2 = SelfCalibSirGaiaData(self.extspecnames,self.listallgrisms, self.tables, self.ncoeff, self.limmag, wcenters[i],self.deltaw,grism, self.noisefactor, self.ndither,self.mdb,outdir=self.outdir) </span>
<span class="sd">                </span>
<span class="sd">                ##########debugging###################</span>
<span class="sd">                print(&#39;grism:&#39;,grisms_names[list_grisms_main.index(grism)])</span>
<span class="sd">                print(&#39;wave:&#39;,wcenters[i])</span>
<span class="sd">                ##########debugging###################</span>
<span class="sd">                m = SelfCalib(data2,grisms_names[list_grisms_main.index(grism)],self.mdb,self.optxml)</span>
<span class="sd">                m.fit()</span>
<span class="sd">                g = list_grisms_main.index(grism) </span>
<span class="sd">                self.cube[i,:,:,g], self.errcube[i,:,:,g],self.gap[i,:,:,g] = m.OutputSir(self.spatialres,0)</span>
<span class="sd">                m.makePlots(wcenters[i])</span>
<span class="sd">                </span>
<span class="sd">                ### saving the catalog now for test/debug can be commented out</span>
<span class="sd">                ###np.savez(&#39;../star_catalog_g&#39;+str(grism)+&#39;_w&#39;+str(wcenters[i])+&#39;.npz&#39;,data2.obs,data2.catalog,data2.index_star2obs,data2.index_det2obs)</span>
<span class="sd">                &#39;&#39;&#39;</span>
            <span class="c1">#JX 10-25-2024 SpeedUp: Only load data once for each grism.</span>
            <span class="n">spec_forGW</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>     
            <span class="c1">## if self cal observations or simulations exist no need to dither things (default mode = 0)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calmode</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">SelfCalibSirData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">listallgrisms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">,</span> <span class="n">wcenters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span><span class="p">,</span><span class="n">grism</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

            <span class="c1">## simple random simulation of dithering spectra in the absence of SelfCal observations (mode = 1)    </span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calmode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">SelfCalibSirData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">,</span> <span class="n">wcenters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span><span class="p">,</span><span class="n">grism</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">SelfDitherData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span> <span class="n">spec_forGW</span><span class="o">.</span><span class="n">getGWAPositionName</span><span class="p">(),</span> <span class="n">ndithers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ndither</span><span class="p">,</span><span class="n">noisefactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span><span class="p">)</span> 
                    
            <span class="c1">## More realistic simulation of selfCal pattern using GAIA star positions in the absence of SelfCal (mode=2)    </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">SelfCalibSirGaiaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">listallgrisms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limmag</span><span class="p">,</span> <span class="n">wcenters</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaw</span><span class="p">,</span><span class="n">grism</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisefactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndither</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span> 
                
            <span class="c1">#JX 10-25-2024 SpeedUp: Created the loop on i, and the Data2_i class.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="p">):</span>
                <span class="c1">##########debugging###################</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;grism:&#39;</span><span class="p">,</span><span class="n">grisms_names</span><span class="p">[</span><span class="n">list_grisms_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grism</span><span class="p">)])</span>
                <span class="c1">#JX print(&#39;wave:&#39;,wcenters)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wave:&#39;</span><span class="p">,</span><span class="n">wcenters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="c1">##########debugging###################</span>

                <span class="k">class</span> <span class="nc">Data2_i</span><span class="p">:</span>
                    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">index_star2obs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">index_det2obs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data2_i</span> <span class="o">=</span> <span class="n">Data2_i</span><span class="p">()</span>
                
                <span class="n">data2_i</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">#JX Must copy, not append!</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">index_star2obs</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">index_star2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">index_det2obs</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
                <span class="n">data2_i</span><span class="o">.</span><span class="n">ncoeff</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">ncoeff</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">limmag</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">limmag</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">outdir</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">wcenter</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">wcenter</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">deltaw</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">deltaw</span>
                <span class="n">data2_i</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">mdb</span>

                <span class="n">m</span> <span class="o">=</span> <span class="n">SelfCalib</span><span class="p">(</span><span class="n">data2_i</span><span class="p">,</span><span class="n">grisms_names</span><span class="p">[</span><span class="n">list_grisms_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grism</span><span class="p">)],</span><span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optxml</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">list_grisms_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grism</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">g</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">errcube</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">g</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">OutputSir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatialres</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">makePlots</span><span class="p">(</span><span class="n">wcenters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

                
                <span class="c1">### saving the catalog now for test/debug can be commented out</span>
                <span class="c1">### np.savez(&#39;../star_catalog_g&#39;+str(grism)+&#39;_w&#39;+str(wcenters[i])+&#39;.npz&#39;,data2_i.obs,data2_i.catalog,data2_i.index_star2obs,data2_i.index_det2obs)</span>
            <span class="c1">#JXJXJX</span>


<div class="viewcode-block" id="SelfCalibWave.cross_grism">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave.cross_grism">[docs]</a>
    <span class="k">def</span> <span class="nf">cross_grism</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; To correct for the grism to grism offset before saving the flat cube&#39;&#39;&#39;</span>
        <span class="c1">#for spectrum in refgrism_subsample:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span>    
       
        <span class="n">X</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Y</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Z</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wstart</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wend</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#JX</span>

        <span class="n">fn000</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fn184</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fn004</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">fn180</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">fn270</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">fn00B</span> <span class="o">=</span> <span class="n">RGI</span><span class="p">((</span><span class="n">Z</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">),</span> <span class="n">c</span><span class="p">[:,:,:,</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">[</span><span class="n">fn000</span><span class="p">,</span><span class="n">fn184</span><span class="p">,</span><span class="n">fn004</span><span class="p">,</span><span class="n">fn180</span><span class="p">,</span> <span class="n">fn270</span><span class="p">,</span> <span class="n">fn00B</span><span class="p">]</span>
     
    <span class="c1"># need to improve later</span>
        <span class="n">h5file1</span><span class="p">,</span> <span class="n">h5file2</span><span class="p">,</span> <span class="n">h5file3</span><span class="p">,</span> <span class="n">h5file4</span><span class="p">,</span> <span class="n">h5file5</span> <span class="o">=</span> <span class="p">[],[],[],[],[]</span>
        <span class="n">grispar</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">h5file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extspecnames</span><span class="p">):</span>
            <span class="c1">#grism_orientation = (h5file_name.split(&#39;/&#39;)[-1]).split(&#39;-&#39;)[2]</span>

            <span class="n">grism_orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getGWAPosition</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">getGWATilt</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grism_orientation</span> <span class="o">==</span> <span class="n">grispar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h5file1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">h5file1</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">h5file_name</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grism_orientation</span> <span class="o">==</span> <span class="n">grispar</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h5file2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">h5file2</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">h5file_name</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grism_orientation</span> <span class="o">==</span> <span class="n">grispar</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h5file3</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">h5file3</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">h5file_name</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">grism_orientation</span> <span class="o">==</span> <span class="n">grispar</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h5file4</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 
                <span class="n">h5file4</span> <span class="o">=</span> <span class="n">H5ExtractedSpectraCollection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">h5file_name</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">,])</span>
 
        <span class="n">grisms</span> <span class="o">=</span> <span class="p">[</span><span class="n">h5file2</span><span class="p">,</span><span class="n">h5file3</span><span class="p">,</span><span class="n">h5file4</span><span class="p">]</span>

        <span class="n">corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">grisms</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">spectrum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">h5file1</span><span class="p">):</span>
            <span class="n">this_obj</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getObjectID</span><span class="p">()</span>   
            <span class="n">detector</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">()</span>
            <span class="n">flux1</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualData</span><span class="p">()</span>
            <span class="n">var1</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualVariance</span><span class="p">()</span>
            <span class="n">quality1</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getWavelength</span><span class="p">()</span>
            <span class="n">wstart</span> <span class="o">=</span> <span class="n">wave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wend</span> <span class="o">=</span> <span class="n">wave</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">wcenters</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">m</span><span class="p">,</span><span class="n">dm</span> <span class="o">=</span> <span class="n">measureChunkMagnitude1D</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="n">flux1</span><span class="p">,</span><span class="n">var1</span><span class="p">,</span><span class="n">quality1</span><span class="p">,</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">500</span><span class="p">)</span>                    
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span><span class="mi">18</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dm</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">g</span><span class="p">,</span><span class="n">grism</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grisms</span><span class="p">):</span>
                    <span class="n">s2</span> <span class="o">=</span> <span class="n">grism</span><span class="o">.</span><span class="n">getSpectraByObjectID</span><span class="p">(</span><span class="n">this_obj</span><span class="p">)</span>
                    <span class="n">l</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">dm2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mf">99.0</span><span class="p">,</span><span class="mf">99.0</span>
                    <span class="k">for</span> <span class="n">spectrum2</span> <span class="ow">in</span> <span class="n">s2</span><span class="p">:</span>
                        <span class="n">l</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">detector2</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">()</span>
                        <span class="n">flux2</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualData</span><span class="p">()</span>
                        <span class="n">var2</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getActualVariance</span><span class="p">()</span>
                        <span class="n">quality2</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getSpectrumDataSet</span><span class="p">(</span><span class="n">H5ExtractedSpectrum</span><span class="o">.</span><span class="n">SPEC1D_LABEL</span><span class="p">)</span><span class="o">.</span><span class="n">getQuality</span><span class="p">()</span>
                        <span class="n">wave2</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getWavelength</span><span class="p">()</span>
                        <span class="n">m2</span><span class="p">,</span><span class="n">dm2</span> <span class="o">=</span> <span class="n">measureChunkMagnitude1D</span><span class="p">(</span><span class="n">wave2</span><span class="p">,</span><span class="n">flux2</span><span class="p">,</span><span class="n">var2</span><span class="p">,</span><span class="n">quality2</span><span class="p">,</span><span class="n">wcenters</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">500</span><span class="p">)</span>                    

                    <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">m2</span><span class="o">&lt;</span><span class="mi">18</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dm2</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wcenters</span><span class="p">):</span>        
                            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">getLocationSpectrum</span><span class="p">()</span><span class="o">.</span><span class="n">computePosition</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span> <span class="c1"># pixels</span>
                            <span class="n">xd</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">pixel2det</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># detector</span>
                            <span class="n">xf</span><span class="p">,</span><span class="n">yf</span> <span class="o">=</span> <span class="n">det2focalplane</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xd</span><span class="p">,</span> <span class="n">yd</span><span class="p">)</span> <span class="c1"># focal plane</span>
                            <span class="n">corfactor1</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">xf</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xf</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yf</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yf</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wavelength</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">])</span>    
                                <span class="n">corfactor1</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">pts</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)</span><span class="c1">#compute_ff(c[:,:,:,0],xf,yf,wavelength) </span>
                    
                            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">spectrum2</span><span class="o">.</span><span class="n">getLocationSpectrum</span><span class="p">()</span><span class="o">.</span><span class="n">computePosition</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span> <span class="c1"># pixels</span>
                            <span class="n">xd</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">pixel2det</span><span class="p">(</span><span class="n">detector2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># detector</span>
                            <span class="n">xf</span><span class="p">,</span><span class="n">yf</span> <span class="o">=</span> <span class="n">det2focalplane</span><span class="p">(</span><span class="n">detector2</span><span class="p">,</span> <span class="n">xd</span><span class="p">,</span> <span class="n">yd</span><span class="p">)</span> <span class="c1"># focal plane</span>
                            <span class="n">corfactor2</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">xf</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xf</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yf</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">yf</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wavelength</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">yf</span><span class="p">])</span>    
                                <span class="n">corfactor2</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">fn</span><span class="p">[</span><span class="n">g</span><span class="o">+</span><span class="mi">1</span><span class="p">](</span><span class="n">pts</span><span class="p">)</span><span class="o">/-</span><span class="mf">2.5</span><span class="p">)</span><span class="c1">#compute_ff(c[:,:,:,g+1],xf,yf,wavelength)   </span>
                            
                            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flux1</span><span class="p">[</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="n">wavelength</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="n">wavelength</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span><span class="o">/</span><span class="n">corfactor1</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flux2</span><span class="p">[</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">wave2</span><span class="p">,</span><span class="n">wavelength</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">wave2</span><span class="p">,</span><span class="n">wavelength</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span><span class="o">/</span><span class="n">corfactor2</span>
                
                            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="p">],</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">))</span>

        
        <span class="n">grisms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RGS180+4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS000-4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">knum</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">g</span><span class="p">,</span><span class="n">grism</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grisms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wcenters</span><span class="p">):</span>        
                <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="n">w</span><span class="p">,:,:,</span><span class="n">g</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="p">],</span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span><span class="p">))</span>
            
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grisms</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">wcenters</span><span class="p">),</span><span class="n">knum</span><span class="p">)</span>
                <span class="n">no</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="p">],</span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">),</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Grism:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">grism</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; at w:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;mean:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="p">],</span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">))))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;corrections in log&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">knum</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;10-Crossgrism_corrections.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div>


                
<div class="viewcode-block" id="SelfCalibWave.quality_prod">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave.quality_prod">[docs]</a>
    <span class="k">def</span> <span class="nf">quality_prod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sigmaclip</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; To check the quality of the calculated response&#39;&#39;&#39;</span>
        
        <span class="c1">#JX</span>
        <span class="c1">#Create an empty container</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating DQC...&#39;</span><span class="p">)</span>
        
        <span class="c1">### fix grisms </span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span>    
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">list_grisms_main</span> <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> 
        <span class="n">grisms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RGS000&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180+4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS000-4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">,</span><span class="s1">&#39;RGS270&#39;</span><span class="p">,</span><span class="s1">&#39;BGS000&#39;</span><span class="p">]</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">grism</span> <span class="ow">in</span> <span class="n">list_grisms_main</span><span class="p">:</span><span class="c1">#self.list_grisms:</span>
            <span class="n">real_grism</span><span class="o">=</span><span class="n">grisms</span><span class="p">[</span><span class="n">list_grisms_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grism</span><span class="p">)]</span> 
            <span class="n">g</span> <span class="o">=</span> <span class="n">list_grisms_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">grism</span><span class="p">)</span>
            <span class="n">avg_array</span><span class="o">=</span><span class="p">[]</span> <span class="c1">#JX</span>
            <span class="n">std_array</span><span class="o">=</span><span class="p">[]</span> <span class="c1">#JX</span>
            
            <span class="k">if</span> <span class="n">grism</span>  <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1">#JX wstart = 11000.0# 8548.5 problamatic all 0</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">9000.0</span><span class="c1">#8548.5</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">13862.1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcenters</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcenters</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">11900.0</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">19002.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcenters</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcenters</span>


            <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">):</span>

                <span class="n">corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">w</span><span class="p">,:,:,</span><span class="n">g</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_grisms_main</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">),</span><span class="n">knum</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corrections</span><span class="p">)])</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">corrections</span><span class="p">):</span> <span class="c1">#avoiding errors if all array is nan</span>
                    <span class="n">no</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">,</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">),</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corrections</span><span class="p">)],</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">))</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">median_abs_deviation</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corrections</span><span class="p">)],</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="s1">&#39;mean:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span><span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="s1">&#39;NMAD:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span><span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg</span><span class="p">,</span><span class="n">avg</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                    <span class="n">avg_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span> <span class="c1">#JX</span>
                    <span class="n">std_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="c1">#JX</span>
                    <span class="n">knum</span><span class="o">+=</span><span class="mi">1</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Grism:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">real_grism</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; at w:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;corrections in log&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Wavelengths&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dq_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Key&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="s1">&#39;Value&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">/</span><span class="mf">10000.</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                                        <span class="s1">&#39;Description&#39;</span> <span class="p">:</span> <span class="s1">&#39;Wavelength (micron)&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Unit&#39;</span> <span class="p">:</span> <span class="s1">&#39;micron&#39;</span><span class="p">}</span>

            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">real_grism</span><span class="si">}</span><span class="s1">_avg&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dq_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Key&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="s1">&#39;Value&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg_array</span><span class="p">),</span>
                                        <span class="s1">&#39;Description&#39;</span> <span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">real_grism</span><span class="si">}</span><span class="s1"> mean correction (dmag)&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Unit&#39;</span> <span class="p">:</span> <span class="s1">&#39;dmag&#39;</span><span class="p">}</span>

            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">real_grism</span><span class="si">}</span><span class="s1">_std&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dq_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Key&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="s1">&#39;Value&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_array</span><span class="p">),</span>
                                        <span class="s1">&#39;Description&#39;</span> <span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">real_grism</span><span class="si">}</span><span class="s1"> stdDev (dmag)&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Unit&#39;</span> <span class="p">:</span> <span class="s1">&#39;dmag&#39;</span><span class="p">}</span>

            <span class="c1"># param = ppr_dict.genericKVParam()</span>
            <span class="c1"># param.Key = f&#39;Wavelengths&#39;</span>
            <span class="c1"># param.Description = f&#39;Wavelength (micron)&#39;</span>
            <span class="c1"># param.StringValue = &quot; &quot;.join(np.array_str(np.round(wavelengths/10000.,2)).split()) #JX Convert wavelengths values to micron</span>
            <span class="c1"># param.Unit = &#39;&#39;</span>
            <span class="c1"># self.dq_parameters.Parameter.append(param)</span>
            
            <span class="c1"># param = ppr_dict.genericKVParam()</span>
            <span class="c1"># param.Key = f&#39;{real_grism}_avg&#39;</span>
            <span class="c1"># param.Description = f&#39;{real_grism} mean correction (dmag)&#39;</span>
            <span class="c1"># np_avg_arr = np.array(avg_array)</span>
            <span class="c1"># param.StringValue = &quot; &quot;.join(np.array_str(np_avg_arr).split())</span>
            <span class="c1"># #param.Unit = &#39;&#39;</span>
            <span class="c1"># self.dq_parameters.Parameter.append(param)</span>

            <span class="c1"># param = ppr_dict.genericKVParam()</span>
            <span class="c1"># param.Key = f&#39;{real_grism}_std&#39;</span>
            <span class="c1"># param.Description = f&#39;{real_grism} stdDev (dmag)&#39;</span>
            <span class="c1"># np_std_arr = np.array(std_array)</span>
            <span class="c1"># param.StringValue = &quot; &quot;.join(np.array_str(np_std_arr).split())</span>
            <span class="c1"># #param.Unit = &#39;&#39;</span>
            <span class="c1"># self.dq_parameters.Parameter.append(param)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;11-quality_histograms.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div>

        

    <span class="c1">#JX</span>
<div class="viewcode-block" id="SelfCalibWave.get_dq_parameters">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave.get_dq_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dq_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current dqc parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: dqc parameters dict ready to be written in XML objet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dq_parameters</span></div>

        
        
<div class="viewcode-block" id="SelfCalibWave.writeOutputSir">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalibWave.writeOutputSir">[docs]</a>
    <span class="k">def</span> <span class="nf">writeOutputSir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">msfits</span><span class="p">,</span> <span class="n">iterative</span><span class="p">):</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving output file in &quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()])</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">]</span><span class="o">=</span>             <span class="s1">&#39;Euclid&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">]</span><span class="o">=</span>               <span class="s1">&#39;NISP&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FITS_DEF&#39;</span><span class="p">]</span><span class="o">=</span>      <span class="s1">&#39;sir.relativeFuxScaling&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FITS_VER&#39;</span><span class="p">]</span><span class="o">=</span>                <span class="s1">&#39;0.1&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;VERSION&#39;</span><span class="p">]</span> <span class="o">=</span>     <span class="s1">&#39;SC8-NIP-F3_159&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SOFTVERS&#39;</span><span class="p">]</span> <span class="o">=</span>     <span class="mf">0.0</span>     
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span>    <span class="o">=</span>      <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSMODE&#39;</span><span class="p">]</span> <span class="o">=</span>            <span class="s1">&#39;CALIBRATION&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ORIGIN&#39;</span><span class="p">]</span>  <span class="o">=</span>               <span class="s1">&#39;Shooby&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;IMG_CAT&#39;</span><span class="p">]</span> <span class="o">=</span>              <span class="s1">&#39;CALIB&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ValidityRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2050-01-01T00:00:00.0&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CalibrationID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        
        <span class="n">grisms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RGS000&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180+4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS000-4&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">,</span> <span class="s1">&#39;RGS270&#39;</span><span class="p">,</span> <span class="s1">&#39;BGS000&#39;</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RGS000&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">,</span><span class="s1">&#39;RGS000&#39;</span><span class="p">,</span><span class="s1">&#39;RGS180&#39;</span><span class="p">,</span><span class="s1">&#39;RGS270&#39;</span><span class="p">,</span><span class="s1">&#39;BGS000&#39;</span><span class="p">]</span>
        <span class="n">tilt</span> <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grisms</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grism/Tilt &quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">npix</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">spatialres</span>

            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">g</span> 
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GWA_POS&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;GWA_TILT&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">tilt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        
            <span class="c1">#X-axis (dispersion) on focal plane</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;FP&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CUNIT1&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;norm&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL1&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="mf">0.99</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">1.</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>

            <span class="c1">#Y-axis (spatial) on focal plane</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;FP&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CUNIT2&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;norm&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL2&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="mf">0.99</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">1.</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT2&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">g</span>  <span class="o">==</span> <span class="s1">&#39;BGS000&#39;</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">9000.0</span><span class="c1">#8548.5</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">13862.1</span>
                <span class="n">wcent</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wstart</span> <span class="o">=</span> <span class="mf">11900.0</span>
                <span class="n">wend</span> <span class="o">=</span> <span class="mf">19002.0</span>
                <span class="n">wcent</span> <span class="o">=</span> <span class="n">wstart</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wend</span><span class="o">-</span><span class="n">wstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#Wavelength dimension</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;Wave&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CUNIT3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">wcent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#goes to self.wvcent[0]</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRPIX3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wcent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">wcent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">wcent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT3&quot;</span><span class="p">]</span><span class="o">=</span> <span class="mf">0.</span> 
                        
                    
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel_sigma</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">cu_wave</span> <span class="o">=</span> <span class="n">sigma_clipped_mean</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#remove outlier in wavelength direction</span>
                <span class="n">cu_spatial</span> <span class="o">=</span> <span class="n">smooth_avoidgaps</span><span class="p">(</span><span class="n">cu_wave</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="o">//</span><span class="mi">2</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_kernel_sigma</span><span class="p">)</span> <span class="c1"># smooth spatially</span>
                <span class="n">cu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cu_spatial</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># put the same smooth solution in all wavebins</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="s1">&#39;done----------&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cu</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># no smoothing in w or spatially</span>

            <span class="n">cu_smooth</span> <span class="o">=</span> <span class="n">nan_helper</span><span class="p">(</span><span class="n">cu</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cube_swap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cu_smooth</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#swap axis for consistency</span>
            
            <span class="k">if</span> <span class="n">iterative</span><span class="p">:</span>   
                <span class="n">incube</span><span class="p">,</span><span class="n">inerrcube</span> <span class="o">=</span> <span class="n">MakeCubeTess</span><span class="p">(</span><span class="n">msfits</span><span class="p">)</span> <span class="c1"># this is the input ms_flat file from previous run</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube_swap</span><span class="o">+</span><span class="n">incube</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="s1">&#39;.SCI&#39;</span><span class="p">)</span> <span class="c1">#iterative</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cube_swap</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="s1">&#39;.SCI&#39;</span><span class="p">)</span>

            <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

            <span class="c1">#The DQ layer will be a sigmoid function of S/N of the solution.</span>
            <span class="c1">#For S/N ~ 5 and above it goes to 1, for S/N ~ 1 and below it goes to 0. -DCM</span>
            
            <span class="n">DQ_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveres</span><span class="p">):</span>

                <span class="n">mmcubeprime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">mmcubeprime</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mmcubeprime</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">mmerrcubeprime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">errcube</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">])</span>
                <span class="n">mmerrcubeprime</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mmerrcubeprime</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">10.0</span>
                
                <span class="n">xvals</span> <span class="o">=</span> <span class="o">-</span><span class="mf">120.</span><span class="o">*</span><span class="n">mmerrcubeprime</span><span class="o">+</span><span class="mf">5.4</span>    
                <span class="n">DQ_layer</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xvals</span><span class="p">))</span>
            
            <span class="n">dq_smooth</span> <span class="o">=</span> <span class="n">nan_helper</span><span class="p">(</span><span class="n">DQ_layer</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dq_swap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">dq_smooth</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#swap axis for consistency</span>

            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dq_swap</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">g</span> <span class="o">+</span> <span class="s1">&#39;.DQ&#39;</span><span class="p">)</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>
</div>


        
<span class="c1">###################################################################################################</span>
<span class="c1">#################### per grism per waveband fitting similar to NIR#################################</span>
<span class="c1">###################################################################################################</span>

<div class="viewcode-block" id="SelfCalib">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib">[docs]</a>
<span class="k">class</span> <span class="nc">SelfCalib</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to implement Self-calibration algorithms&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">grismname</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span><span class="n">optxml</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_stars</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">par_flat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;X_det&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Y_det&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">par_flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fit2DNP</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="c1">#par_flat.append(Fit2DCheb(data.ncoeff, x, y))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">par_flat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span> <span class="o">=</span> <span class="n">mdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optxml</span> <span class="o">=</span> <span class="n">optxml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grismname</span> <span class="o">=</span> <span class="n">grismname</span>
        
<div class="viewcode-block" id="SelfCalib.expectedUncertainties">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.expectedUncertainties">[docs]</a>
    <span class="k">def</span> <span class="nf">expectedUncertainties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">16</span><span class="p">))</span></div>


<div class="viewcode-block" id="SelfCalib.obsData">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.obsData">[docs]</a>
    <span class="k">def</span> <span class="nf">obsData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SelfCalib.obsUncert">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.obsUncert">[docs]</a>
    <span class="k">def</span> <span class="nf">obsUncert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAGERR_APER&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SelfCalib.model_starMag">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.model_starMag">[docs]</a>
    <span class="k">def</span> <span class="nf">model_starMag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="SelfCalib.model_flat">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.model_flat">[docs]</a>
    <span class="k">def</span> <span class="nf">model_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="SelfCalib.model_detQE">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.model_detQE">[docs]</a>
    <span class="k">def</span> <span class="nf">model_detQE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="SelfCalib.model">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.model">[docs]</a>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_starMag</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_flat</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_detQE</span><span class="p">()</span></div>


<div class="viewcode-block" id="SelfCalib.residuals">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.residuals">[docs]</a>
    <span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsData</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsUncert</span><span class="p">()</span></div>


<div class="viewcode-block" id="SelfCalib.chisquare">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.chisquare">[docs]</a>
    <span class="k">def</span> <span class="nf">chisquare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="SelfCalib.redchisquare">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.redchisquare">[docs]</a>
    <span class="k">def</span> <span class="nf">redchisquare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">npar_flat</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param_val</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_stars</span><span class="p">)</span> <span class="o">-</span> <span class="n">npar_flat</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisquare</span><span class="p">()</span> <span class="o">/</span> <span class="n">dof</span></div>


<div class="viewcode-block" id="SelfCalib.fitFlat">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.fitFlat">[docs]</a>
    <span class="k">def</span> <span class="nf">fitFlat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">obsData</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_starMag</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">model_detQE</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">obsUncert</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="SelfCalib.fitStarMag">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.fitStarMag">[docs]</a>
    <span class="k">def</span> <span class="nf">fitStarMag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">obsUncert</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">obsData</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_flat</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">model_detQE</span><span class="p">())</span>
        <span class="c1">#for i in range(0, len(m.par_stars)):</span>
        <span class="c1">#    j = m.data.index_star2obs[i]</span>
        <span class="c1">#    mask_mag = np.ma.MaskedArray(d[j], mask=np.isnan(d[j]))</span>
        <span class="c1">#    mask_err = np.ma.MaskedArray(unc[j], mask=np.isnan(d[j]))</span>
        <span class="c1">#    m.par_stars[&#39;mag&#39;][i] = np.ma.average(mask_mag, weights=1./mask_err)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">par_stars</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index_star2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">par_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">unc</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">m</span><span class="o">.</span><span class="n">par_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span></div>


<div class="viewcode-block" id="SelfCalib.flattenResiduals">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.flattenResiduals">[docs]</a>
    <span class="k">def</span> <span class="nf">flattenResiduals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">chi0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsData</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">chi1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chi1</span> <span class="o">-</span> <span class="n">chi0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bkp</span>
        <span class="k">return</span> <span class="n">chi1</span> <span class="o">-</span> <span class="n">chi0</span></div>


<div class="viewcode-block" id="SelfCalib.fitQE">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.fitQE">[docs]</a>
    <span class="k">def</span> <span class="nf">fitQE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># fig, ax = plt.subplots()</span>
        <span class="c1"># ax = fig.add_subplot(111, projection=&#39;3d&#39;)</span>
        <span class="k">for</span> <span class="n">det1</span> <span class="ow">in</span> <span class="n">NIRFP</span><span class="p">()</span><span class="o">.</span><span class="n">detnames</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">det2</span> <span class="ow">in</span> <span class="n">NIRFP</span><span class="p">()</span><span class="o">.</span><span class="n">detnames</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">det_neighbour</span><span class="p">(</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">det1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">det2</span><span class="p">):</span>
                        <span class="k">continue</span>  <span class="c1"># avoid repetitions</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">FPCoordsGaps</span><span class="p">(</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
                    <span class="n">cc1</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">toDetCoords</span><span class="p">(</span><span class="n">use_det</span><span class="o">=</span><span class="n">det1</span><span class="p">)</span>
                    <span class="n">cc2</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">toDetCoords</span><span class="p">(</span><span class="n">use_det</span><span class="o">=</span><span class="n">det2</span><span class="p">)</span>
                    <span class="n">idet1</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">(</span><span class="n">det1</span><span class="p">)</span>
                    <span class="n">idet2</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">(</span><span class="n">det2</span><span class="p">)</span>
                    

                    <span class="n">idet1_maybe</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">idet2_maybe</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fp</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet1_maybe</span><span class="p">]</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span><span class="n">cc1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cc1</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">v2</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet2_maybe</span><span class="p">]</span><span class="o">.</span><span class="n">extrapolate</span><span class="p">(</span><span class="n">cc2</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cc2</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="c1"># ax.scatter(fp.x[i], fp.y[i], v1, marker=&#39;.&#39;, s=np.abs(v1) * 100)</span>
                        <span class="c1"># ax.scatter(fp.x[i], fp.y[i], v2, marker=&#39;.&#39;, s=np.abs(v2) * 100)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">det1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span>  <span class="mi">1</span>
                        <span class="n">row</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">det2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mat</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Add constraint for the average and drop first row from mat</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=-</span><span class="mf">1.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">NIRFP</span><span class="p">()</span><span class="o">.</span><span class="n">detnames</span><span class="p">():</span>
            <span class="n">idet</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">addGlobalOffset</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="SelfCalib.fit">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.fit">[docs]</a>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected uncertainties (at each location): &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">expectedUncertainties</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial chisq. &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">())</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chi0</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">fitStarMag</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">flattenResiduals</span><span class="p">()</span>  <span class="c1"># ensure residuals are flattened across the detectors</span>
            <span class="n">m</span><span class="o">.</span><span class="n">fitFlat</span><span class="p">()</span>
            <span class="n">chi1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">()</span>
            <span class="n">deltachi</span> <span class="o">=</span> <span class="n">chi1</span> <span class="o">-</span> <span class="n">chi0</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Iter </span><span class="si">{iter:4d}</span><span class="s2">,  red. chisq.: </span><span class="si">{chi1:10.6g}</span><span class="s2">   delta: </span><span class="si">{deltachi:10.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="o">=</span><span class="nb">iter</span><span class="p">,</span> <span class="n">chi1</span><span class="o">=</span><span class="n">chi1</span><span class="p">,</span> <span class="n">deltachi</span><span class="o">=</span><span class="n">deltachi</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deltachi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">iter</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
                <span class="n">m</span><span class="o">.</span><span class="n">fitStarMag</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final chisq. &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">redchisquare</span><span class="p">())</span>
        <span class="n">printStatistics</span><span class="p">(</span><span class="s2">&quot;Residuals&quot;</span> <span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">residuals</span><span class="p">())</span>
        <span class="n">printStatistics</span><span class="p">(</span><span class="s2">&quot;Flat [mag] (pre-QE) &quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">model_flat</span><span class="p">())</span>
        <span class="c1">#m.fitQE()  # Flatten large scale pattern across all detectors (chi sq. is unaffected)</span>
        <span class="n">printStatistics</span><span class="p">(</span><span class="s2">&quot;QE [mag]&quot;</span>  <span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">)</span>
        <span class="n">printStatistics</span><span class="p">(</span><span class="s2">&quot;Flat [mag] (post-QE)&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">model_flat</span><span class="p">())</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">elapsed</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s2">&quot; [s]&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="SelfCalib.interpolateOnDetector">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.interpolateOnDetector">[docs]</a>
    <span class="k">def</span> <span class="nf">interpolateOnDetector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">idet</span> <span class="o">=</span> <span class="n">_idet</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">cartesianProduct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">predict_at</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">uncert_at</span><span class="p">(</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SelfCalib.interpolateOnFocal">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.interpolateOnFocal">[docs]</a>
    <span class="k">def</span> <span class="nf">interpolateOnFocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">cartesianProduct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1">#######latest by shoob Aug 11,2023##############</span>
        <span class="n">detmod</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">=</span><span class="n">OpticalModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optxml</span><span class="p">,</span> <span class="n">detmod</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getEnvelopeBox</span><span class="p">()</span>
        
        <span class="n">_nx</span><span class="p">,</span><span class="n">_ny</span><span class="o">=</span> <span class="n">normalfov_r</span><span class="p">(</span><span class="n">box</span><span class="p">,(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">))</span>
        
        <span class="n">v</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_nx</span><span class="p">)):</span>
            <span class="n">p</span><span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getPixel</span><span class="p">(</span><span class="n">_nx</span><span class="p">[</span><span class="n">d</span><span class="p">],</span><span class="n">_ny</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>      
            <span class="n">detx</span><span class="p">,</span><span class="n">dety</span> <span class="o">=</span><span class="n">normaldet</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">idet</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">getDetectorNumber</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">idet</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">## change to m.par_flar</span>
                <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">uncert_at</span><span class="p">(</span> <span class="n">detx</span><span class="p">,</span> <span class="n">dety</span><span class="p">))</span> <span class="c1">## same</span>
                <span class="n">gap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">predict_at</span><span class="p">(</span><span class="n">detx</span><span class="p">,</span> <span class="n">dety</span><span class="p">))</span> <span class="c1">## change to m.par_flar</span>
                <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">par_flat</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span><span class="o">.</span><span class="n">uncert_at</span><span class="p">(</span> <span class="n">detx</span><span class="p">,</span> <span class="n">dety</span><span class="p">))</span> <span class="c1">## same</span>
                <span class="n">gap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idet</span><span class="p">)</span>
            <span class="c1">#print(idet,v)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gap</span><span class="p">)</span>
        
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">unc</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SelfCalib.smoothbaba">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.smoothbaba">[docs]</a>
    <span class="k">def</span> <span class="nf">smoothbaba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

        <span class="n">copya</span><span class="o">=</span><span class="n">a</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span> <span class="o">=</span> <span class="n">find_bounds</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span><span class="n">idet</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
            <span class="n">copya</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">copya</span></div>

    
<div class="viewcode-block" id="SelfCalib.OutputSir">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.OutputSir">[docs]</a>
    <span class="k">def</span> <span class="nf">OutputSir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span><span class="n">smooth_kernel_sigma</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xsize</span><span class="p">,</span><span class="n">xsize</span><span class="p">])</span>
        <span class="n">pix_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">xsize</span><span class="p">)</span>
        <span class="n">pix_y</span> <span class="o">=</span> <span class="n">pix_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnFocal</span><span class="p">(</span><span class="n">pix_x</span><span class="p">,</span> <span class="n">pix_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smooth_kernel_sigma</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">smoothbaba</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">smooth_kernel_sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">unc</span><span class="p">,</span><span class="n">gap</span><span class="p">)</span></div>



<div class="viewcode-block" id="SelfCalib.makePlots">
<a class="viewcode-back" href="../../SIR_RFXModel.html#SIR_RFXModel.SelfCalib.SelfCalib.makePlots">[docs]</a>
    <span class="k">def</span> <span class="nf">makePlots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wave</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">outdir</span>
        <span class="n">mdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdb</span>
        <span class="c1">#box=[[-82.5,-78],[82.5,78]] ### Focal plane in mm</span>
        <span class="c1"># Residuals</span>
    
        <span class="n">detmod</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">,</span> <span class="n">mdb</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">=</span><span class="n">OpticalModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">optxml</span><span class="p">,</span> <span class="n">detmod</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getEnvelopeBox</span><span class="p">()</span>

        <span class="c1"># Residuals</span>
    
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Obs. constraint (color=detector)&quot;</span><span class="p">)</span>    
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Norm. residuals&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">))</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index_det2obs</span><span class="p">[</span><span class="n">idet</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">residuals</span><span class="p">()[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> <span class="n">count</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;04-Residuals_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Norm. residuals&quot;</span><span class="p">)</span>  <span class="c1"># TODO: check this plot...</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;05-ResidualsHisto_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>



        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">residuals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tmp</span><span class="p">)])</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Norm. residuals&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;X_fp&#39;</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Y_fp&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">tmp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tmp</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">))</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;06-ResidualsOnFocalPlane_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span> <span class="o">=</span> <span class="n">normaldet_r</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span> <span class="c1"># in pixel on detector</span>

        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="n">det_id</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorID</span><span class="p">(</span><span class="n">idet</span><span class="p">)</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="o">=</span><span class="p">[],[]</span>
            <span class="k">for</span> <span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getFOVPosition</span><span class="p">(</span><span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span><span class="p">,</span><span class="n">det_id</span><span class="p">)</span>
                <span class="n">_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span> <span class="c1"># on focal plane in mm</span>
            <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span> <span class="n">normalfov</span><span class="p">(</span><span class="n">box</span><span class="p">,(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">))</span> <span class="c1">#on focalplane normal</span>
            <span class="n">_nx</span><span class="p">,</span><span class="n">_ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">_ny</span><span class="p">,</span> <span class="n">_nx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Flat field pattern&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
        <span class="c1">#plt.xlim([-1,1]); plt.ylim([1,-1])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;07-FlatPattern3D_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span> <span class="o">=</span> <span class="n">normaldet_r</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span> <span class="c1"># in pixel on detector</span>

        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span><span class="c1">#np.min((rr[0], val.min()))</span>
            <span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span><span class="c1">#np.max((rr[1], val.max()))</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="n">det_id</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorID</span><span class="p">(</span><span class="n">idet</span><span class="p">)</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="o">=</span><span class="p">[],[]</span>
            <span class="k">for</span> <span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getFOVPosition</span><span class="p">(</span><span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span><span class="p">,</span><span class="n">det_id</span><span class="p">)</span>
                <span class="n">_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span> <span class="c1"># on focal plane in mm</span>
            <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span> <span class="n">normalfov</span><span class="p">(</span><span class="n">box</span><span class="p">,(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">))</span> <span class="c1">#on focalplane normal</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">_y</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Flat field pattern&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;07-FlatPattern_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;MAG_APER&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">par_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;istar&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tmp</span><span class="p">)])</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>

            <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;X_fp&#39;</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Y_fp&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> \
                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">tmp</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Flat field pattern&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;07-FlatPatternObs_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">par_detqe</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;idet&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tmp</span><span class="p">)])</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;X_fp&#39;</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Y_fp&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">tmp</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;QE&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;07-detq_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span> <span class="o">=</span> <span class="n">normaldet_r</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span> <span class="c1"># in pixel on detector</span>

        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unc</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
            <span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unc</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="n">det_id</span> <span class="o">=</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorID</span><span class="p">(</span><span class="n">idet</span><span class="p">)</span>  
            
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="o">=</span><span class="p">[],[]</span>
            <span class="k">for</span> <span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdet_p</span><span class="p">,</span><span class="n">ydet_p</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">detmod</span><span class="o">.</span><span class="n">getFOVPosition</span><span class="p">(</span><span class="n">xdp</span><span class="p">,</span><span class="n">ydp</span><span class="p">,</span><span class="n">det_id</span><span class="p">)</span>
                <span class="n">_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_x</span><span class="p">,</span><span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span> <span class="c1"># on focal plane in mm</span>
            <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="o">=</span> <span class="n">normalfov</span><span class="p">(</span><span class="n">box</span><span class="p">,(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">))</span> <span class="c1">#on focalplane normal</span>

            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">_y</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">rr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">rr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Flat field uncertainties&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Focal plane Z&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;08-FlatUncert_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ncoeff</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">allv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">allu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idet</span> <span class="ow">in</span> <span class="n">DetectorModel</span><span class="o">.</span><span class="n">getDetectorRange</span><span class="p">():</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unc</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">interpolateOnDetector</span><span class="p">(</span><span class="n">idet</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">allv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">allv</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span>
            <span class="n">allu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">allu</span><span class="p">,</span> <span class="n">unc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">unc</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span>
        

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">allv</span><span class="p">)])</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">allv</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">allv</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Delta magnitude&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;09-FlatPatternHisto_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">allu</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">allu</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">allu</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">allu</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">allu</span><span class="o">.</span><span class="n">std</span><span class="p">()],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">0.006</span><span class="p">,</span> <span class="mf">0.006</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">max</span><span class="p">())),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Uncertainties [mag]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;09-FlatUncertHisto_w&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grismname</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Shoubaneh Hemmati.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>