<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nonlinearity and Saturation &mdash; NIR_NonLinearSaturation 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=2709fde1"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="NIR_NonLinearSaturation" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            NIR_NonLinearSaturation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">NIR_NonLinearSaturation</a></li>
<li class="toctree-l1"><a class="reference internal" href="HowToRunNLApply.html">How to Run the Nonlinearity Apply Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="HowToRunNLCal.html">How to Run the Nonlinearity Calibration Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">NIR_NonLinearSaturation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Nonlinearity and Saturation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nonlinearity-and-saturation">
<h1>Nonlinearity and Saturation<a class="headerlink" href="#nonlinearity-and-saturation" title="Link to this heading"></a></h1>
<p>The component identifier is <strong>NIR_NonLinearSaturation</strong>.
This module corrects for detector non-linearity and masks saturated pixels in the Euclid NISP detectors.</p>
<p>It consists of three main components:</p>
<ol class="arabic simple">
<li><p><strong>Calibration Module</strong> – derives non-linearity correction coefficients from calibration data.</p></li>
<li><p><strong>Non-linearity Application Module</strong> – applies the per-pixel correction model to science exposures.</p></li>
<li><p><strong>Saturation Application Module</strong> – masks pixels exceeding detector-dependent saturation thresholds.</p></li>
</ol>
<section id="scientific-background">
<h2>Scientific Background<a class="headerlink" href="#scientific-background" title="Link to this heading"></a></h2>
<p>Nonlinearity in H2RG detectors arises mainly from changes in the photodiode junction capacitance as charge accumulates. As the depletion region narrows, the effective capacitance increases, altering the conversion from charge to voltage and producing a measurable deviation from linear response. Additional effects in the readout chain—such as the source follower and ADC—contribute further nonlinear behaviour.</p>
<p>Euclid calibrates pixel-level nonlinearity using custom-designed LEDs that illuminate the focal plane at multiple fluence levels. These measurements provide both the nonlinear response and the MACC group data used to estimate the underlying linear flux. Pixel responses are modelled with orthonormal polynomials for stability and efficiency. Reference pixels are corrected, repeated exposures are averaged, high-fluence frames are excluded, and the resulting coefficients with full covariance matrices form the nonlinearity calibration products used in the NIR pipeline. The validity range of the coefficients is set by the LED fluence coverage.</p>
</section>
<section id="non-linearity-calibration-module">
<h2>Non-linearity Calibration Module<a class="headerlink" href="#non-linearity-calibration-module" title="Link to this heading"></a></h2>
<p>The calibration module derives the pixel-level model used by the apply module. It ingests a list of calibration XML files (SUTR ramps taken at multiple fluence levels) and produces, for each MACC configuration (PHOTO / SPECTRO):</p>
<ul class="simple">
<li><p>a coefficient cube (<code class="docutils literal notranslate"><span class="pre">nir.NLCoefficients</span></code>),</p></li>
<li><p>a covariance cube (<code class="docutils literal notranslate"><span class="pre">nir.NLCovariance</span></code>),</p></li>
<li><p>a failed-pixel mask (<code class="docutils literal notranslate"><span class="pre">nir.NLMask</span></code>).</p></li>
</ul>
<p><strong>Input data and flux sampling</strong></p>
<p>For each calibration file, the module:</p>
<ul class="simple">
<li><p>reads MACC parameters (NG, NR, ND),</p></li>
<li><p>identifies detector and FPA slot metadata from the MDB,</p></li>
<li><p>computes the effective LED flux from commanded settings and LED lookup tables,</p></li>
<li><p>assigns flux-level identifiers so repeated exposures can be combined.</p></li>
</ul>
<p>Typically five fluence levels are used per mode, spanning the expected dynamic range.</p>
<p>For each detector and exposure, the module:</p>
<ul class="simple">
<li><p>reads the frame ramps and applies the validated reference-pixel correction,</p></li>
<li><p>reads the upstream ramp-fitted slope and its uncertainty,</p></li>
<li><p>flattens the data and fits orthonormal polynomials to determine the non-linearity parameter for each pixel,</p></li>
<li><p>averages measurements across repeated exposures at each fluence level.</p></li>
</ul>
<p><strong>Polynomial fit and quality control</strong></p>
<p>For every pixel:</p>
<ul class="simple">
<li><p>the averaged non-linearity measurements are fitted with an n-th order polynomial (currently 4th order),</p></li>
<li><p>the resulting polynomial coefficients and full covariance matrix are recorded,</p></li>
<li><p>unusable or NaN measurements are masked and filled with average values solely to stabilize the fit,</p></li>
<li><p>pixels for which the fit fails or produces invalid coefficients are added to the failed-pixel mask.</p></li>
</ul>
<p>The final calibration products include:</p>
<ul>
<li><p>a coefficient cube:</p>
<p><code class="docutils literal notranslate"><span class="pre">{f_low,</span> <span class="pre">f_up,</span> <span class="pre">a0,</span> <span class="pre">a1,</span> <span class="pre">a2,</span> <span class="pre">a3,</span> <span class="pre">a4}</span></code></p>
<p>where <code class="docutils literal notranslate"><span class="pre">f_low</span></code> and <code class="docutils literal notranslate"><span class="pre">f_up</span></code> define the validity range and <code class="docutils literal notranslate"><span class="pre">a0..a4</span></code> are the polynomial coefficients;</p>
</li>
<li><p>a covariance cube of shape <code class="docutils literal notranslate"><span class="pre">(n_coeff,</span> <span class="pre">n_coeff,</span> <span class="pre">ny,</span> <span class="pre">nx)</span></code> storing the full covariance matrix for <code class="docutils literal notranslate"><span class="pre">a0..a4</span></code> at each pixel;</p></li>
<li><p>a failed-pixel mask identifying pixels that cannot be reliably corrected.</p></li>
</ul>
<p>All products are written as Euclid-compliant FITS files, with one extension per detector and appropriate metadata.</p>
<p>See <a class="reference internal" href="HowToRunNLCal.html"><span class="doc">How to Run the Nonlinearity Calibration Module</span></a> for instructions on running the calibration module.</p>
</section>
<section id="non-linearity-application-module">
<h2>Non-linearity Application Module<a class="headerlink" href="#non-linearity-application-module" title="Link to this heading"></a></h2>
<p>The non-linearity apply module linearises the detector response, propagates uncertainties, and sets appropriate data-quality flags.</p>
<p>For each input exposure, the module:</p>
<ul class="simple">
<li><p>reads the SCI, VAR, and DQ arrays for all detectors,</p></li>
<li><p>identifies PHOTO or SPECTRO MACC mode,</p></li>
<li><p>selects the correct calibration XML for that configuration,</p></li>
<li><p>loads the coefficient cube, covariance cube, and failed-pixel mask,</p></li>
<li><p>loads the detector gain map (applied after the correction).</p></li>
</ul>
<p>The coefficient cube provides, per pixel, a lower and upper validity limit and a set of polynomial coefficients describing the calibrated response. These limits may be overridden by a configuration file if needed.</p>
<p><strong>Flagging before correction</strong></p>
<p>Pixels are flagged as non-linear (<code class="docutils literal notranslate"><span class="pre">NLINEAR</span></code>) if:</p>
<ul class="simple">
<li><p>their values fall below the lower limit or above the upper limit,</p></li>
<li><p>they are saturated (<code class="docutils literal notranslate"><span class="pre">SATUR</span></code> already set),</p></li>
<li><p>their signal is non-positive,</p></li>
<li><p>they are marked as failed in the calibration mask.</p></li>
</ul>
<p>For non-dark frames, such pixels are additionally flagged as <code class="docutils literal notranslate"><span class="pre">INVALID</span></code>. Their SCI/VAR values are unchanged.</p>
<p><strong>Applying the correction</strong></p>
<p>For all remaining pixels, the module:</p>
<ul>
<li><p>evaluates the calibrated per-pixel polynomial</p>
<p><code class="docutils literal notranslate"><span class="pre">f(x)</span> <span class="pre">=</span> <span class="pre">a0</span> <span class="pre">+</span> <span class="pre">a1</span> <span class="pre">x</span> <span class="pre">+</span> <span class="pre">a2</span> <span class="pre">x²</span> <span class="pre">+</span> <span class="pre">...</span></code></p>
<p>to produce a linearised SCI image,</p>
</li>
<li><p>propagates uncertainties using the full covariance matrix, producing an updated VAR image,</p></li>
<li><p>performs linear extrapolation for pixels above the upper validity limit, using the derivative of the polynomial at that limit.</p></li>
</ul>
<p>If the correction produces unphysical results (e.g., enormous absolute values or a positive input becoming negative), the original pixel values are restored and the corresponding DQ flags are set.</p>
<p>After the non-linearity correction, the detector gain map is applied so SCI and VAR are expressed in the appropriate physical units. Metadata fields such as <code class="docutils literal notranslate"><span class="pre">NREJNL</span></code> (pixels flagged as non-linear) are updated.</p>
<p>For usage examples, arguments, and command-line execution, see
<a class="reference internal" href="HowToRunNLApply.html"><span class="doc">How to Run the Nonlinearity Apply Module</span></a>.</p>
</section>
<section id="saturation-application-module">
<h2>Saturation Application Module<a class="headerlink" href="#saturation-application-module" title="Link to this heading"></a></h2>
<p>The saturation module masks pixels for which the true flux cannot be reliably recovered. Saturated pixels are flagged using dedicated mask bits; pixels that later fail non-linearity checks are flagged separately.</p>
<p>On-board software assigns saturation flags when pixel values reach the nominal 16-bit limit, but ground processing provides a more accurate detection because:</p>
<ul class="simple">
<li><p>on-board logic may miss cases where only the final reads saturate,</p></li>
<li><p>upstream corrections (non-linearity, IPC) can push values into saturation,</p></li>
<li><p>some pixels saturate below the nominal limit,</p></li>
<li><p>MDB saturation maps provide detector-specific, pixel-dependent thresholds.</p></li>
</ul>
<p>In the ground pipeline, saturation masking is performed by <code class="docutils literal notranslate"><span class="pre">SaturationProg</span></code>:</p>
<ul class="simple">
<li><p>reads the exposure and the MDB saturation map,</p></li>
<li><p>compares per-pixel SCI values to their thresholds,</p></li>
<li><p>may optionally expand the mask to neighbouring pixels depending on configuration and pipeline version,</p></li>
<li><p>sets <code class="docutils literal notranslate"><span class="pre">SATUR</span></code> and <code class="docutils literal notranslate"><span class="pre">INVALID</span></code> in the DQ plane,</p></li>
<li><p>records <code class="docutils literal notranslate"><span class="pre">NSATPIX</span></code> in the metadata.</p></li>
</ul>
<p>The SCI layer is left unchanged. Downstream steps—including non-linearity correction—rely on these DQ flags to handle saturated pixels appropriately.</p>
<p>For details on running the saturation task, see <a class="reference internal" href="HowToRunNLApply.html"><span class="doc">How to Run the Nonlinearity Apply Module</span></a>.</p>
</section>
<section id="purpose-and-requirements">
<h2>Purpose and Requirements<a class="headerlink" href="#purpose-and-requirements" title="Link to this heading"></a></h2>
<p>Primary requirement: <strong>&lt;1.5% relative photometry per source</strong> (R-CAL-A-NP-1000).
Non-linearity must be corrected to <strong>&lt;0.3%</strong> (R-NIR-CAL-NA-050).</p>
<p>Other applicable requirements include:</p>
<ul class="simple">
<li><p>R-NIR-CAL-NA-051: Non-linearity solution error &lt; 0.9%</p></li>
<li><p>R-NIR-MSK-NA-020 / 030: Saturation imaging/spectra</p></li>
<li><p>R-NIR-MSK-F-010 / 020: Masking rules</p></li>
<li><p>R-SIR-CAL-010, 140, 200, 220: Calibration and bad pixels</p></li>
<li><p>R-SIR-PRD-F-100, 140, 160, 170: Product specifications</p></li>
<li><p>R-SIR-QUA-CN-010, F-010, F-020: Quality control</p></li>
</ul>
</section>
<section id="function-summary">
<h2>Function Summary<a class="headerlink" href="#function-summary" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Saturation module</strong>
Masks saturated pixels using MDB thresholds and updates DQ flags.</p></li>
<li><p><strong>Non-linearity module</strong>
Applies per-pixel non-linearity corrections and propagates uncertainties.</p></li>
<li><p><strong>Calibration module</strong>
Fits per-pixel polynomial models from SUTR calibration data.</p></li>
</ul>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">NIR_NonLinearSaturation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="NIR_NonLinearSaturation.html">NIR_NonLinearSaturation package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="HowToRunNLApply.html">How to Run the Nonlinearity Apply Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLApply.html#source-code">Source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLApply.html#command-syntax">Command syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLApply.html#inputs">Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLApply.html#outputs">Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLApply.html#test-data">Test data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="HowToRunNLCal.html">How to Run the Nonlinearity Calibration Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#source-code">Source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#inputs">Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#outputs">Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#environment">Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#directory-structure">Directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#execution-steps">Execution steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="HowToRunNLCal.html#configuration-file-examples">Configuration file examples</a></li>
</ul>
</li>
</ul>
</div>
</section>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-right" title="NIR_NonLinearSaturation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Shoubaneh Hemmati.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>